<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeeMarshall - Secrets Debug Console</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- BeeMarshall Branding -->
    <link href="css/brand.css" rel="stylesheet">
    
    <style>
        .debug-section {
            background: var(--white);
            border: 2px solid var(--dark-yellow);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-hive);
        }
        
        .debug-header {
            background: var(--light-yellow);
            border-bottom: 2px solid var(--dark-yellow);
            padding: 1rem;
            margin: -1.5rem -1.5rem 1.5rem -1.5rem;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background-color: var(--success); }
        .status-warning { background-color: var(--warning); }
        .status-danger { background-color: var(--danger); }
        .status-info { background-color: var(--info); }
        
        .code-block {
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            padding: 1rem;
            font-family: var(--font-family-mono);
            font-size: var(--font-size-sm);
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .test-button {
            margin: 0.25rem;
        }
        
        .log-entry {
            padding: 0.5rem;
            margin: 0.25rem 0;
            border-radius: var(--radius-sm);
            font-family: var(--font-family-mono);
            font-size: var(--font-size-sm);
        }
        
        .log-success { background: var(--bg-success); border-left: 4px solid var(--success); }
        .log-warning { background: var(--bg-warning); border-left: 4px solid var(--warning); }
        .log-danger { background: var(--bg-danger); border-left: 4px solid var(--danger); }
        .log-info { background: var(--bg-info); border-left: 4px solid var(--info); }
        
        .secret-value {
            font-family: var(--font-family-mono);
            background: var(--gray-100);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            word-break: break-all;
        }
        
        .masked-secret {
            color: var(--gray-500);
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="bi bi-bug-fill text-hive-primary"></i>
                    BeeMarshall Secrets Debug Console
                </h1>
                <p class="text-center text-muted mb-4">
                    Comprehensive testing and debugging for GitHub Secrets integration
                </p>
            </div>
        </div>

        <!-- Environment Variables Status -->
        <div class="debug-section">
            <div class="debug-header">
                <h3><i class="bi bi-gear-fill"></i> Environment Variables Status</h3>
            </div>
            <div id="envStatus"></div>
        </div>

        <!-- Admin Accounts Testing -->
        <div class="debug-section">
            <div class="debug-header">
                <h3><i class="bi bi-person-check-fill"></i> Admin Accounts Testing</h3>
            </div>
            <div id="adminAccountsStatus"></div>
            <div class="mt-3">
                <h5>Test Authentication:</h5>
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" id="quickTestUsername" class="form-control mb-2" placeholder="Username">
                    </div>
                    <div class="col-md-6">
                        <input type="password" id="quickTestPassword" class="form-control mb-2" placeholder="Password">
                    </div>
                </div>
                <button class="btn btn-primary test-button" onclick="testAuthentication()">
                    <i class="bi bi-key-fill"></i> Test Login
                </button>
                <button class="btn btn-outline-primary test-button" onclick="testAllAccounts()">
                    <i class="bi bi-people-fill"></i> Test All Accounts
                </button>
                <button class="btn btn-outline-info test-button" onclick="testMainAppLogin()">
                    <i class="bi bi-window"></i> Test Main App Login
                </button>
            </div>
        </div>

        <!-- Firebase Configuration Testing -->
        <div class="debug-section">
            <div class="debug-header">
                <h3><i class="bi bi-cloud-fill"></i> Firebase Configuration Testing</h3>
            </div>
            <div id="firebaseStatus"></div>
            <div class="mt-3">
                <button class="btn btn-primary test-button" onclick="testFirebaseConnection()">
                    <i class="bi bi-wifi"></i> Test Firebase Connection
                </button>
                <button class="btn btn-outline-primary test-button" onclick="testFirebaseAuth()">
                    <i class="bi bi-shield-check"></i> Test Firebase Auth
                </button>
            </div>
        </div>

        <!-- GitHub Actions Workflow Status -->
        <div class="debug-section">
            <div class="debug-header">
                <h3><i class="bi bi-github"></i> GitHub Actions Workflow Status</h3>
            </div>
            <div id="workflowStatus"></div>
            <div class="mt-3">
                <button class="btn btn-primary test-button" onclick="checkWorkflowStatus()">
                    <i class="bi bi-arrow-clockwise"></i> Check Workflow Status
                </button>
                <button class="btn btn-outline-primary test-button" onclick="triggerWorkflow()">
                    <i class="bi bi-play-fill"></i> Trigger Workflow
                </button>
            </div>
        </div>

        <!-- Live Debug Log -->
        <div class="debug-section">
            <div class="debug-header">
                <h3><i class="bi bi-terminal-fill"></i> Live Debug Log</h3>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                    <i class="bi bi-trash"></i> Clear Log
                </button>
            </div>
            <div id="debugLog" style="max-height: 400px; overflow-y: auto; background: var(--gray-100); padding: 1rem; border-radius: var(--radius-md);"></div>
        </div>

        <!-- System Information -->
        <div class="debug-section">
            <div class="debug-header">
                <h3><i class="bi bi-info-circle-fill"></i> System Information</h3>
            </div>
            <div id="systemInfo"></div>
        </div>

        <!-- Troubleshooting Guide -->
        <div class="debug-section">
            <div class="debug-header">
                <h3><i class="bi bi-wrench"></i> Troubleshooting Guide</h3>
            </div>
            <div id="troubleshootingGuide"></div>
        </div>

        <!-- Login Testing -->
        <div class="debug-section">
            <div class="debug-header">
                <h3><i class="bi bi-shield-lock-fill"></i> Login Testing</h3>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <h5>Admin Account Testing</h5>
                    <div class="mb-3">
                        <label for="testUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="testUsername" placeholder="Enter username">
                    </div>
                    <div class="mb-3">
                        <label for="testPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="testPassword" placeholder="Enter password">
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="testLogin()">
                            <i class="bi bi-key-fill"></i> Test Login
                        </button>
                        <button class="btn btn-outline-secondary" onclick="testPasswordStrength()">
                            <i class="bi bi-shield-check"></i> Test Password Strength
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5>Quick Tests</h5>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="testPasswordConsistency()">
                            <i class="bi bi-arrow-repeat"></i> Test Password Consistency
                        </button>
                        <button class="btn btn-outline-warning" onclick="testRateLimit()">
                            <i class="bi bi-clock-history"></i> Test Rate Limiting
                        </button>
                        <button class="btn btn-outline-info" onclick="testBcrypt()">
                            <i class="bi bi-lock-fill"></i> Test bcrypt Availability
                        </button>
                        <button class="btn btn-outline-success" onclick="testAdminPasswordSecurity()">
                            <i class="bi bi-person-check"></i> Test Admin Security
                        </button>
                        <button class="btn btn-outline-info" onclick="testTemporaryPasswordGeneration()">
                            <i class="bi bi-key"></i> Test Temp Password Gen
                        </button>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <h6>Test Results:</h6>
                <div id="loginTestResults" class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Click "Test Login" to see results here
                </div>
            </div>
        </div>

        <!-- Task ID Display Debugging -->
        <div class="debug-section">
            <div class="debug-header">
                <h3><i class="bi bi-list-task"></i> Task ID Display Debugging</h3>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <h6>Test Task ID Resolution:</h6>
                    <div class="mb-3">
                        <label for="testTaskId" class="form-label">Task ID to Test:</label>
                        <input type="text" id="testTaskId" class="form-control" placeholder="e.g., task_1, task_2, site_visit_inventory" value="task_1">
                    </div>
                    <div class="mb-3">
                        <label for="testTaskName" class="form-label">Task Name (optional):</label>
                        <input type="text" id="testTaskName" class="form-control" placeholder="Leave empty to test ID-only lookup">
                    </div>
                    <button class="btn btn-primary test-button" onclick="testTaskDisplayName()">
                        <i class="bi bi-search"></i> Test Task Display Name
                    </button>
                </div>
                <div class="col-md-6">
                    <h6>Available Task IDs:</h6>
                    <div id="availableTaskIds" class="code-block" style="max-height: 200px; overflow-y: auto;">
                        <i class="bi bi-info-circle"></i> Click "Load Task Data" to see available task IDs
                    </div>
                    <button class="btn btn-outline-secondary btn-sm mt-2" onclick="loadTaskData()">
                        <i class="bi bi-arrow-clockwise"></i> Load Task Data
                    </button>
                </div>
            </div>
            <div class="mt-3">
                <h6>Test Results:</h6>
                <div id="taskDisplayResults" class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Click "Test Task Display Name" to see results here
                </div>
            </div>
        </div>

        <!-- Security Audit -->
        <div class="debug-section">
            <div class="debug-header">
                <h3><i class="bi bi-shield-exclamation"></i> Security Audit</h3>
            </div>
            <div class="d-grid gap-2">
                <button class="btn btn-danger" onclick="runSecurityAudit()">
                    <i class="bi bi-shield-check"></i> Run Complete Security Audit
                </button>
                <button class="btn btn-outline-danger" onclick="testFirebaseSecurity()">
                    <i class="bi bi-database-exclamation"></i> Test Firebase Security Rules
                </button>
                <button class="btn btn-outline-warning" onclick="testFirebaseRulesComprehensive()">
                    <i class="bi bi-shield-check"></i> Comprehensive Rules Test
                </button>
            </div>
            <div class="mt-3">
                <h6>Security Audit Results:</h6>
                <div id="securityAuditResults" class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Click "Run Complete Security Audit" to see results here
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="debug-section">
            <div class="debug-header">
                <h3><i class="bi bi-lightning-fill"></i> Quick Actions</h3>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-success" onclick="runAllTests()">
                    <i class="bi bi-play-circle-fill"></i> Run All Tests
                </button>
                <button class="btn btn-warning" onclick="exportDebugInfo()">
                    <i class="bi bi-download"></i> Export Debug Info
                </button>
                <button class="btn btn-info" onclick="openMainApp()">
                    <i class="bi bi-box-arrow-up-right"></i> Open Main App
                </button>
                <button class="btn btn-outline-danger" onclick="resetAll()">
                    <i class="bi bi-arrow-clockwise"></i> Reset All
                </button>
            </div>
        </div>
    </div>

    <!-- Load Environment Configuration -->
    <script src="js/env-config.js"></script>
    <script src="js/config.js"></script>
    
    <!-- bcrypt for secure password hashing -->
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
    
    <script src="js/core.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>

    <script>
        // Debug Console JavaScript
        let debugLog = [];
        let testResults = {};

        // Initialize debug console
        document.addEventListener('DOMContentLoaded', function() {
            log('Debug console initialized', 'info');
            
            // Check if env-config.js loaded successfully
            if (typeof window.ENV_GBTECH_USERNAME === 'undefined') {
                log('❌ env-config.js not loaded - GitHub Secrets not injected', 'danger');
                log('This indicates the GitHub Actions workflow may not have run or failed', 'warning');
            } else {
                log('✅ env-config.js loaded successfully', 'success');
            }
            
            updateAllStatus();
            
            // Auto-refresh every 5 seconds
            setInterval(updateAllStatus, 5000);
        });

        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                message,
                type
            };
            debugLog.push(logEntry);
            
            const logElement = document.getElementById('debugLog');
            const logDiv = document.createElement('div');
            logDiv.className = `log-entry log-${type}`;
            logDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logElement.appendChild(logDiv);
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Sync status functions (required by core.js)
        function showSyncStatus(message, type = 'info', showTimestamp = false) {
            // Mock function for test-secrets.html - not needed for testing
            console.log(`[SYNC] ${type}: ${message}`);
        }

        function hideSyncStatus() {
            // Mock function for test-secrets.html - not needed for testing
            console.log('[SYNC] Status hidden');
        }

        function showSyncError(message) {
            // Mock function for test-secrets.html - not needed for testing
            console.log(`[SYNC ERROR] ${message}`);
        }

        // Update all status sections
        function updateAllStatus() {
            updateEnvironmentStatus();
            updateAdminAccountsStatus();
            updateFirebaseStatus();
            updateWorkflowStatus();
            updateSystemInfo();
            updateTroubleshootingGuide();
        }

        // Environment Variables Status
        function updateEnvironmentStatus() {
            const envVars = [
                'ENV_GBTECH_USERNAME',
                'ENV_GBTECH_PASSWORD',
                'ENV_LARS_USERNAME',
                'ENV_LARS_PASSWORD',
                'ENV_FIREBASE_API_KEY',
                'ENV_FIREBASE_AUTH_DOMAIN',
                'ENV_FIREBASE_DATABASE_URL',
                'ENV_FIREBASE_PROJECT_ID',
                'ENV_FIREBASE_STORAGE_BUCKET',
                'ENV_FIREBASE_MESSAGING_SENDER_ID',
                'ENV_FIREBASE_APP_ID'
            ];

            let html = '';
            
            // Check if env-config.js is loaded
            if (typeof window.ENV_GBTECH_USERNAME === 'undefined') {
                html += `
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-exclamation-triangle-fill"></i> Environment Configuration Not Loaded</h5>
                        <p>The <code>env-config.js</code> file is not loaded. This means:</p>
                        <ul>
                            <li>GitHub Actions workflow may not have run</li>
                            <li>GitHub Secrets may not be properly configured</li>
                            <li>You may be viewing a cached version</li>
                        </ul>
                        <p><strong>Solutions:</strong></p>
                        <ol>
                            <li>Check if GitHub Actions workflow has completed</li>
                            <li>Verify GitHub Secrets are properly set</li>
                            <li>Clear browser cache and refresh</li>
                            <li>Wait a few minutes for deployment to complete</li>
                        </ol>
                    </div>
                `;
            } else {
                html += '<div class="row">';
                envVars.forEach(varName => {
                    const value = window[varName];
                    const status = value ? (value.includes('[') || value.includes('YOUR_') ? 'warning' : 'success') : 'danger';
                    const statusText = value ? (value.includes('[') || value.includes('YOUR_') ? 'Placeholder' : 'Set') : 'Missing';
                    
                    html += `
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center">
                                <span class="status-indicator status-${status}"></span>
                                <strong>${varName}:</strong>
                                <span class="ms-2 badge bg-${status === 'success' ? 'success' : status === 'warning' ? 'warning' : 'danger'}">${statusText}</span>
                            </div>
                            <div class="secret-value mt-1">
                                ${value ? (varName.includes('PASSWORD') || varName.includes('KEY') ? '••••••••' : value) : 'Not set'}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            document.getElementById('envStatus').innerHTML = html;
        }

        // Admin Accounts Status
        function updateAdminAccountsStatus() {
            let html = '';
            
            if (window.SecureConfig) {
                const accounts = window.SecureConfig.getAdminAccounts();
                const accountKeys = Object.keys(accounts);
                
                html += `<p><span class="status-indicator status-success"></span><strong>SecureConfig loaded:</strong> ${accountKeys.length} accounts found</p>`;
                
                if (accountKeys.length > 0) {
                    html += '<div class="row">';
                    accountKeys.forEach(key => {
                        // Hide sensitive account details for security
                        html += `
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">Admin Account ${key}</h6>
                                        <p class="card-text">
                                            <small class="text-muted">Status: Active</small><br>
                                            <small class="text-muted">Security: Secured</small><br>
                                            <small class="text-muted">Details: Hidden for security</small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += '<p class="text-warning">No admin accounts loaded</p>';
                }
            } else {
                html += '<p class="text-danger">SecureConfig not available</p>';
            }
            
            document.getElementById('adminAccountsStatus').innerHTML = html;
        }

        // Firebase Status
        function updateFirebaseStatus() {
            let html = '';
            
            const firebaseConfig = {
                apiKey: window.ENV_FIREBASE_API_KEY,
                authDomain: window.ENV_FIREBASE_AUTH_DOMAIN,
                databaseURL: window.ENV_FIREBASE_DATABASE_URL,
                projectId: window.ENV_FIREBASE_PROJECT_ID,
                storageBucket: window.ENV_FIREBASE_STORAGE_BUCKET,
                messagingSenderId: window.ENV_FIREBASE_MESSAGING_SENDER_ID,
                appId: window.ENV_FIREBASE_APP_ID
            };
            
            const configKeys = Object.keys(firebaseConfig);
            const validConfig = configKeys.every(key => firebaseConfig[key] && !firebaseConfig[key].includes('YOUR_'));
            
            html += `<p><span class="status-indicator status-${validConfig ? 'success' : 'warning'}"></span><strong>Firebase Config:</strong> ${validConfig ? 'Valid' : 'Invalid/Incomplete'}</p>`;
            
            if (validConfig) {
                html += '<div class="code-block">';
                html += `Project ID: ${firebaseConfig.projectId}\n`;
                html += `Database URL: ${firebaseConfig.databaseURL}\n`;
                html += `Auth Domain: ${firebaseConfig.authDomain}`;
                html += '</div>';
            } else {
                html += '<p class="text-warning">Firebase configuration contains placeholder values</p>';
            }
            
            document.getElementById('firebaseStatus').innerHTML = html;
        }

        // Workflow Status
        function updateWorkflowStatus() {
            let html = '';
            
            // Check if we're on GitHub Pages
            const isGitHubPages = window.location.hostname.includes('github.io');
            const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            html += `<p><span class="status-indicator status-${isGitHubPages ? 'success' : isLocal ? 'warning' : 'info'}"></span><strong>Environment:</strong> ${isGitHubPages ? 'GitHub Pages' : isLocal ? 'Local Development' : 'Unknown'}</p>`;
            
            if (isGitHubPages) {
                html += '<p class="text-success">Running on GitHub Pages - secrets should be injected</p>';
            } else if (isLocal) {
                html += '<p class="text-warning">Running locally - using placeholder values</p>';
            }
            
            document.getElementById('workflowStatus').innerHTML = html;
        }

        // System Information
        function updateSystemInfo() {
            const info = {
                'User Agent': navigator.userAgent,
                'Platform': navigator.platform,
                'Language': navigator.language,
                'Online': navigator.onLine ? 'Yes' : 'No',
                'URL': window.location.href,
                'Timestamp': new Date().toISOString(),
                'Screen Resolution': `${screen.width}x${screen.height}`,
                'Viewport Size': `${window.innerWidth}x${window.innerHeight}`
            };
            
            let html = '<div class="row">';
            Object.entries(info).forEach(([key, value]) => {
                html += `
                    <div class="col-md-6 mb-2">
                        <strong>${key}:</strong>
                        <div class="secret-value">${value}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            document.getElementById('systemInfo').innerHTML = html;
        }

        // Troubleshooting Guide
        function updateTroubleshootingGuide() {
            const isGitHubPages = window.location.hostname.includes('github.io');
            const envConfigLoaded = typeof window.ENV_GBTECH_USERNAME !== 'undefined';
            
            let html = '';
            
            if (!isGitHubPages) {
                html += `
                    <div class="alert alert-info">
                        <h5><i class="bi bi-info-circle-fill"></i> Local Development Mode</h5>
                        <p>You're running locally. The debug console will show placeholder values for environment variables.</p>
                        <p>To test with real secrets, deploy to GitHub Pages.</p>
                    </div>
                `;
            } else if (!envConfigLoaded) {
                html += `
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-exclamation-triangle-fill"></i> GitHub Secrets Not Injected</h5>
                        <p>The GitHub Actions workflow has not run or failed. Here's how to fix it:</p>
                        
                        <h6>Step 1: Check GitHub Actions</h6>
                        <ol>
                            <li>Go to your repository's GitHub Actions page</li>
                            <li>Look for the "Deploy to GitHub Pages" workflow</li>
                            <li>Check if it's running or has failed</li>
                        </ol>
                        
                        <h6>Step 2: Verify GitHub Secrets</h6>
                        <ol>
                            <li>Go to your repository's Settings > Secrets and variables > Actions</li>
                            <li>Verify these secrets are set:
                                <ul>
                                    <li><code>GBTECH_USERNAME</code></li>
                                    <li><code>GBTECH_PASSWORD</code></li>
                                    <li><code>LARS_USERNAME</code></li>
                                    <li><code>LARS_PASSWORD</code></li>
                                    <li><code>FIREBASE_API_KEY</code></li>
                                    <li><code>FIREBASE_AUTH_DOMAIN</code></li>
                                    <li><code>FIREBASE_DATABASE_URL</code></li>
                                    <li><code>FIREBASE_PROJECT_ID</code></li>
                                    <li><code>FIREBASE_STORAGE_BUCKET</code></li>
                                    <li><code>FIREBASE_MESSAGING_SENDER_ID</code></li>
                                    <li><code>FIREBASE_APP_ID</code></li>
                                </ul>
                            </li>
                        </ol>
                        
                        <h6>Step 3: Trigger Workflow</h6>
                        <ol>
                            <li>Make a small change to any file (like adding a space)</li>
                            <li>Commit and push the change</li>
                            <li>This will trigger the GitHub Actions workflow</li>
                            <li>Wait 3-5 minutes for deployment to complete</li>
                        </ol>
                        
                        <h6>Step 4: Clear Cache</h6>
                        <ol>
                            <li>Hard refresh the page (Ctrl+F5 or Cmd+Shift+R)</li>
                            <li>Or clear browser cache completely</li>
                        </ol>
                    </div>
                `;
            } else {
                html += `
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle-fill"></i> System Working Correctly</h5>
                        <p>GitHub Secrets are properly injected and the system is working as expected.</p>
                    </div>
                `;
            }
            
            document.getElementById('troubleshootingGuide').innerHTML = html;
        }

        // Test Functions
        function testAuthentication() {
            const username = document.getElementById('quickTestUsername').value;
            const password = document.getElementById('quickTestPassword').value;
            
            if (!username || !password) {
                log('Please enter both username and password', 'warning');
                return;
            }
            
            log(`Testing authentication (username hidden for security)`, 'info');
            
            if (window.SecureConfig) {
                const accounts = window.SecureConfig.getAdminAccounts();
                log(`Found ${Object.keys(accounts).length} admin accounts (names hidden for security)`, 'info');
                
                const account = Object.values(accounts).find(acc => 
                    acc.username.toLowerCase() === username.toLowerCase() && acc.password === password
                );
                
                if (account) {
                    log(`✅ Authentication successful`, 'success');
                    log(`Account verified (details hidden for security)`, 'info');
                } else {
                    log(`❌ Authentication failed`, 'danger');
                    log(`Account not found (usernames hidden for security)`, 'info');
                }
            } else {
                log('❌ SecureConfig not available', 'danger');
            }
        }

        function testAllAccounts() {
            log('Testing all admin accounts...', 'info');
            
            if (window.SecureConfig) {
                const accounts = window.SecureConfig.getAdminAccounts();
                const accountCount = Object.keys(accounts).length;
                log(`Testing ${accountCount} admin accounts (usernames hidden for security)...`, 'info');
                // Note: We can't test passwords without knowing them
            } else {
                log('❌ SecureConfig not available', 'danger');
            }
        }

        function testFirebaseConnection() {
            log('Testing Firebase connection...', 'info');
            
            try {
                const firebaseConfig = {
                    apiKey: window.ENV_FIREBASE_API_KEY,
                    authDomain: window.ENV_FIREBASE_AUTH_DOMAIN,
                    databaseURL: window.ENV_FIREBASE_DATABASE_URL,
                    projectId: window.ENV_FIREBASE_PROJECT_ID,
                    storageBucket: window.ENV_FIREBASE_STORAGE_BUCKET,
                    messagingSenderId: window.ENV_FIREBASE_MESSAGING_SENDER_ID,
                    appId: window.ENV_FIREBASE_APP_ID
                };
                
                if (firebaseConfig.apiKey && !firebaseConfig.apiKey.includes('YOUR_')) {
                    firebase.initializeApp(firebaseConfig);
                    const database = firebase.database();
                    log('✅ Firebase initialized successfully', 'success');
                } else {
                    log('❌ Firebase configuration invalid', 'danger');
                }
            } catch (error) {
                log(`❌ Firebase error: ${error.message}`, 'danger');
            }
        }

        function testFirebaseAuth() {
            log('Testing Firebase authentication...', 'info');
            // Add Firebase auth testing here
        }

        function checkWorkflowStatus() {
            log('Checking GitHub Actions workflow status...', 'info');
            
            // Check if we're on GitHub Pages
            const isGitHubPages = window.location.hostname.includes('github.io');
            
            if (isGitHubPages) {
                log('✅ Running on GitHub Pages - checking for env-config.js', 'info');
                
                // Try to fetch the env-config.js file
                fetch('js/env-config.js')
                    .then(response => {
                        if (response.ok) {
                            log('✅ env-config.js found on GitHub Pages', 'success');
                            return response.text();
                        } else {
                            log('❌ env-config.js not found on GitHub Pages (404)', 'danger');
                            throw new Error('env-config.js not found');
                        }
                    })
                    .then(content => {
                        if (content.includes('YOUR_') || content.includes('[')) {
                            log('⚠️ env-config.js contains placeholder values - GitHub Secrets not injected', 'warning');
                        } else {
                            log('✅ env-config.js contains real values - GitHub Secrets injected', 'success');
                        }
                    })
                    .catch(error => {
                        log(`❌ Error checking env-config.js: ${error.message}`, 'danger');
                        log('This indicates the GitHub Actions workflow has not run or failed', 'warning');
                    });
            } else {
                log('⚠️ Not running on GitHub Pages - using local configuration', 'warning');
            }
        }

        function triggerWorkflow() {
            log('Triggering GitHub Actions workflow...', 'info');
            
            // Open GitHub Actions page in new tab (URL hidden for security)
            log('Opening GitHub Actions page (URL hidden for security)', 'info');
            // Note: URL removed for security - user should navigate manually
            
            log('Opened GitHub Actions page - check if workflow is running', 'info');
            log('If no workflow is running, you may need to push a commit to trigger it', 'warning');
        }

        // Utility Functions
        function clearLog() {
            debugLog = [];
            document.getElementById('debugLog').innerHTML = '';
            log('Debug log cleared', 'info');
        }

        function runAllTests() {
            log('Running all tests...', 'info');
            
            // Test environment variables
            updateAllStatus();
            
            // Test Firebase connection
            testFirebaseConnection();
            
            // Test login functionality
            log('Testing login functionality...', 'info');
            testBcrypt();
            
            // Call the local test functions (not window functions to avoid recursion)
            testPasswordConsistencyLocal();
            testAdminPasswordSecurityLocal();
            testRateLimit();
            testTemporaryPasswordGeneration();
            
            // Test task ID display functionality
            log('Testing task ID display functionality...', 'info');
            loadTaskData();
            testTaskDisplayName();
            
            // Run security audit
            log('Running security audit...', 'info');
            runSecurityAudit();
            testFirebaseSecurity();
            
            log('All tests completed', 'success');
        }

        function exportDebugInfo() {
            const debugData = {
                timestamp: new Date().toISOString(),
                environment: {
                    isGitHubPages: window.location.hostname.includes('github.io'),
                    isLocal: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1',
                    url: window.location.href
                },
                envVars: {
                    ENV_GBTECH_USERNAME: window.ENV_GBTECH_USERNAME,
                    ENV_GBTECH_PASSWORD: window.ENV_GBTECH_PASSWORD ? '••••••••' : 'Not set',
                    ENV_LARS_USERNAME: window.ENV_LARS_USERNAME,
                    ENV_LARS_PASSWORD: window.ENV_LARS_PASSWORD ? '••••••••' : 'Not set',
                    ENV_FIREBASE_API_KEY: window.ENV_FIREBASE_API_KEY ? '••••••••' : 'Not set',
                    ENV_FIREBASE_PROJECT_ID: window.ENV_FIREBASE_PROJECT_ID
                },
                adminAccounts: window.SecureConfig ? 'Loaded (details hidden for security)' : 'Not available',
                debugLog: debugLog
            };
            
            const blob = new Blob([JSON.stringify(debugData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `beemarshall-debug-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('Debug info exported', 'success');
        }

        function openMainApp() {
            window.open('beemarshall-full.html', '_blank');
        }

        function testMainAppLogin() {
            log('Testing main app login functionality...', 'info');
            
            // Open main app in new window
            const mainAppWindow = window.open('beemarshall-full.html', '_blank');
            
            // Wait for window to load, then test
            setTimeout(() => {
                try {
                    if (mainAppWindow && !mainAppWindow.closed) {
                        log('Main app opened successfully', 'success');
                        log('You can now test login in the main app window', 'info');
                        log('Check the browser console for login debug messages', 'info');
                    } else {
                        log('Failed to open main app window', 'danger');
                    }
                } catch (error) {
                    log(`Error testing main app: ${error.message}`, 'danger');
                }
            }, 2000);
        }

        function resetAll() {
            if (confirm('Are you sure you want to reset all debug data?')) {
                clearLog();
                updateAllStatus();
                log('Debug console reset', 'info');
            }
        }

        // ===== LOGIN TESTING FUNCTIONS =====

        function testLogin() {
            const username = document.getElementById('testUsername').value;
            const password = document.getElementById('testPassword').value;
            const resultsDiv = document.getElementById('loginTestResults');
            
            if (!username || !password) {
                resultsDiv.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> Please enter both username and password</div>';
                return;
            }
            
            log(`🧪 Testing login (username hidden for security)`, 'info');
            
            try {
                // Test admin authentication
                if (window.SecureConfig) {
                    const accounts = window.SecureConfig.getAdminAccounts();
                    const account = Object.values(accounts).find(acc => 
                        acc.username.toLowerCase() === username.toLowerCase()
                    );
                    
                    if (account) {
                        // Test password verification
                        if (typeof verifyPassword === 'function') {
                            const isValid = verifyPassword(password, account.passwordHash);
                            if (isValid) {
                                resultsDiv.innerHTML = `
                                    <div class="alert alert-success">
                                        <h6><i class="bi bi-check-circle-fill"></i> Login Test Successful</h6>
                                        <p><strong>Status:</strong> Authentication verified</p>
                                        <p><strong>Role:</strong> ${account.role}</p>
                                        <p><strong>Tenant:</strong> ${account.tenantId}</p>
                                        <p><strong>Security:</strong> Password hash verified (details hidden)</p>
                                    </div>
                                `;
                                log(`✅ Login successful (details hidden for security)`, 'success');
                            } else {
                                resultsDiv.innerHTML = `
                                    <div class="alert alert-danger">
                                        <h6><i class="bi bi-x-circle-fill"></i> Login Test Failed</h6>
                                        <p><strong>Status:</strong> Account found but password incorrect</p>
                                        <p><strong>Security:</strong> Password verification failed</p>
                                        <p><strong>Hash Type:</strong> ${account.passwordHash.startsWith('$2') ? 'bcrypt' : 'fallback'}</p>
                                    </div>
                                `;
                                log(`❌ Password verification failed (details hidden for security)`, 'danger');
                            }
                        } else {
                            resultsDiv.innerHTML = `
                                <div class="alert alert-warning">
                                    <h6><i class="bi bi-exclamation-triangle"></i> verifyPassword function not available</h6>
                                    <p>Core.js may not be loaded properly</p>
                                </div>
                            `;
                            log(`⚠️ verifyPassword function not available`, 'warning');
                        }
                    } else {
                        // Test employee authentication
                        log(`🔄 Checking employee authentication (username hidden for security)...`, 'info');
                        resultsDiv.innerHTML = `
                            <div class="alert alert-info">
                                <h6><i class="bi bi-person-check"></i> Testing Employee Authentication</h6>
                                <p>Admin account not found, checking employee accounts...</p>
                                <p><em>Note: Employee authentication requires Firebase connection</em></p>
                            </div>
                        `;
                        log(`ℹ️ Admin account not found, would check employee accounts`, 'info');
                    }
                } else {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="bi bi-x-circle-fill"></i> Configuration Error</h6>
                            <p>SecureConfig not available</p>
                        </div>
                    `;
                    log(`❌ SecureConfig not available`, 'danger');
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-x-circle-fill"></i> Test Error</h6>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
                log(`❌ Login test error: ${error.message}`, 'danger');
            }
        }

        function testPasswordStrength() {
            const password = document.getElementById('testPassword').value;
            const resultsDiv = document.getElementById('loginTestResults');
            
            if (!password) {
                resultsDiv.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> Please enter a password to test</div>';
                return;
            }
            
            if (typeof validatePasswordStrength === 'function') {
                const result = validatePasswordStrength(password);
                let strengthClass = 'danger';
                let strengthIcon = 'bi-x-circle-fill';
                
                if (result.score >= 80) {
                    strengthClass = 'success';
                    strengthIcon = 'bi-check-circle-fill';
                } else if (result.score >= 60) {
                    strengthClass = 'warning';
                    strengthIcon = 'bi-exclamation-triangle-fill';
                }
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-${strengthClass}">
                        <h6><i class="bi ${strengthIcon}"></i> Password Strength Analysis</h6>
                        <p><strong>Score:</strong> ${result.score}/100</p>
                        <p><strong>Strength:</strong> ${result.strength}</p>
                        <p><strong>Length:</strong> ${password.length} characters</p>
                        <ul class="mb-0">
                            ${result.checks.map(check => `<li class="${check.passed ? 'text-success' : 'text-danger'}">${check.message}</li>`).join('')}
                        </ul>
                    </div>
                `;
                log(`🔒 Password strength test: ${result.strength} (${result.score}/100)`, 'info');
            } else {
                resultsDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle"></i> Password Strength Test Unavailable</h6>
                        <p>validatePasswordStrength function not available</p>
                    </div>
                `;
                log(`⚠️ validatePasswordStrength function not available`, 'warning');
            }
        }

        function testPasswordConsistency() {
            const resultsDiv = document.getElementById('loginTestResults');
            
            if (typeof window.testPasswordConsistency === 'function') {
                try {
                    const result = window.testPasswordConsistency();
                    resultsDiv.innerHTML = `
                        <div class="alert alert-${result.consistent ? 'success' : 'danger'}">
                            <h6><i class="bi bi-${result.consistent ? 'check-circle-fill' : 'x-circle-fill'}"></i> Password Consistency Test</h6>
                            <p><strong>Consistent:</strong> ${result.consistent ? 'Yes' : 'No'}</p>
                            <p><strong>Core.js Hash:</strong> ${result.coreHash.substring(0, 30)}...</p>
                            <p><strong>Config.js Hash:</strong> ${result.configHash.substring(0, 30)}...</p>
                            <p><strong>Verification:</strong> ${result.verification ? 'Passed' : 'Failed'}</p>
                        </div>
                    `;
                    log(`🔄 Password consistency test: ${result.consistent ? 'PASSED' : 'FAILED'}`, result.consistent ? 'success' : 'danger');
                } catch (error) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="bi bi-x-circle-fill"></i> Consistency Test Error</h6>
                            <p>${error.message}</p>
                        </div>
                    `;
                    log(`❌ Consistency test error: ${error.message}`, 'danger');
                }
            } else {
                resultsDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle"></i> Consistency Test Unavailable</h6>
                        <p>testPasswordConsistency function not available</p>
                    </div>
                `;
                log(`⚠️ testPasswordConsistency function not available`, 'warning');
            }
        }

        function testRateLimit() {
            const resultsDiv = document.getElementById('loginTestResults');
            
            if (typeof checkRateLimit === 'function') {
                try {
                    const testIp = 'test-ip-123';
                    const result = checkRateLimit(testIp);
                    resultsDiv.innerHTML = `
                        <div class="alert alert-${result.allowed ? 'success' : 'warning'}">
                            <h6><i class="bi bi-${result.allowed ? 'check-circle-fill' : 'clock-fill'}"></i> Rate Limiting Test</h6>
                            <p><strong>Allowed:</strong> ${result.allowed ? 'Yes' : 'No'}</p>
                            <p><strong>Attempts:</strong> ${result.attempts}</p>
                            <p><strong>Remaining:</strong> ${result.remaining}</p>
                            <p><strong>Reset Time:</strong> ${result.resetTime ? new Date(result.resetTime).toLocaleTimeString() : 'N/A'}</p>
                        </div>
                    `;
                    log(`⏱️ Rate limit test: ${result.allowed ? 'ALLOWED' : 'BLOCKED'} (${result.attempts} attempts)`, result.allowed ? 'success' : 'warning');
                } catch (error) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="bi bi-x-circle-fill"></i> Rate Limit Test Error</h6>
                            <p>${error.message}</p>
                        </div>
                    `;
                    log(`❌ Rate limit test error: ${error.message}`, 'danger');
                }
            } else {
                resultsDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle"></i> Rate Limiting Test Unavailable</h6>
                        <p>checkRateLimit function not available</p>
                    </div>
                `;
                log(`⚠️ checkRateLimit function not available`, 'warning');
            }
        }

        function testBcrypt() {
            const resultsDiv = document.getElementById('loginTestResults');
            
            try {
                const bcryptAvailable = typeof bcrypt !== 'undefined';
                const testPassword = 'test123';
                let testResult = 'Not tested';
                
                if (bcryptAvailable) {
                    const hash = bcrypt.hashSync(testPassword, 12);
                    const verify = bcrypt.compareSync(testPassword, hash);
                    testResult = verify ? 'Working' : 'Failed';
                }
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-${bcryptAvailable ? 'success' : 'warning'}">
                        <h6><i class="bi bi-${bcryptAvailable ? 'check-circle-fill' : 'exclamation-triangle-fill'}"></i> bcrypt Availability Test</h6>
                        <p><strong>Available:</strong> ${bcryptAvailable ? 'Yes' : 'No'}</p>
                        <p><strong>Test Result:</strong> ${testResult}</p>
                        <p><strong>CDN Status:</strong> ${bcryptAvailable ? 'Loaded successfully' : 'Not loaded'}</p>
                    </div>
                `;
                log(`🔐 bcrypt test: ${bcryptAvailable ? 'AVAILABLE' : 'NOT AVAILABLE'}`, bcryptAvailable ? 'success' : 'warning');
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-x-circle-fill"></i> bcrypt Test Error</h6>
                        <p>${error.message}</p>
                    </div>
                `;
                log(`❌ bcrypt test error: ${error.message}`, 'danger');
            }
        }

        function testAdminPasswordSecurity() {
            const resultsDiv = document.getElementById('loginTestResults');
            
            if (typeof window.testAdminPasswordSecurity === 'function') {
                try {
                    const result = window.testAdminPasswordSecurity();
                    resultsDiv.innerHTML = `
                        <div class="alert alert-${result.secure ? 'success' : 'danger'}">
                            <h6><i class="bi bi-${result.secure ? 'check-circle-fill' : 'x-circle-fill'}"></i> Admin Password Security Test</h6>
                            <p><strong>Secure:</strong> ${result.secure ? 'Yes' : 'No'}</p>
                            <p><strong>Plain Text Found:</strong> ${result.plainTextFound ? 'Yes' : 'No'}</p>
                            <p><strong>Hashed Passwords:</strong> ${result.hashedCount}</p>
                            <p><strong>Total Accounts:</strong> ${result.totalAccounts}</p>
                        </div>
                    `;
                    log(`👤 Admin security test: ${result.secure ? 'SECURE' : 'INSECURE'}`, result.secure ? 'success' : 'danger');
                } catch (error) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="bi bi-x-circle-fill"></i> Admin Security Test Error</h6>
                            <p>${error.message}</p>
                        </div>
                    `;
                    log(`❌ Admin security test error: ${error.message}`, 'danger');
                }
            } else {
                resultsDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle"></i> Admin Security Test Unavailable</h6>
                        <p>testAdminPasswordSecurity function not available</p>
                    </div>
                `;
                log(`⚠️ testAdminPasswordSecurity function not available`, 'warning');
            }
        }

        // Local versions for runAllTests() to avoid recursion
        function testPasswordConsistencyLocal() {
            const resultsDiv = document.getElementById('loginTestResults');
            
            if (typeof window.testPasswordConsistency === 'function') {
                try {
                    const result = window.testPasswordConsistency();
                    resultsDiv.innerHTML = `
                        <div class="alert alert-${result.consistent ? 'success' : 'danger'}">
                            <h6><i class="bi bi-${result.consistent ? 'check-circle-fill' : 'x-circle-fill'}"></i> Password Consistency Test</h6>
                            <p><strong>Consistent:</strong> ${result.consistent ? 'Yes' : 'No'}</p>
                            <p><strong>Core.js Hash:</strong> ${result.coreHash.substring(0, 30)}...</p>
                            <p><strong>Config.js Hash:</strong> ${result.configHash.substring(0, 30)}...</p>
                            <p><strong>Details:</strong> ${result.details}</p>
                        </div>
                    `;
                    
                    if (result.consistent) {
                        log(`✅ Password consistency test passed`, 'success');
                    } else {
                        log(`❌ Password consistency test failed: ${result.details}`, 'danger');
                    }
                } catch (error) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="bi bi-x-circle-fill"></i> Consistency Test Error</h6>
                            <p>${error.message}</p>
                        </div>
                    `;
                    log(`❌ Consistency test error: ${error.message}`, 'danger');
                }
            } else {
                resultsDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle"></i> Consistency Test Unavailable</h6>
                        <p>testPasswordConsistency function not available</p>
                    </div>
                `;
                log(`⚠️ testPasswordConsistency function not available`, 'warning');
            }
        }

        function testAdminPasswordSecurityLocal() {
            const resultsDiv = document.getElementById('loginTestResults');
            
            if (typeof window.testAdminPasswordSecurity === 'function') {
                try {
                    const result = window.testAdminPasswordSecurity();
                    resultsDiv.innerHTML = `
                        <div class="alert alert-${result.secure ? 'success' : 'danger'}">
                            <h6><i class="bi bi-${result.secure ? 'check-circle-fill' : 'x-circle-fill'}"></i> Admin Password Security Test</h6>
                            <p><strong>Secure:</strong> ${result.secure ? 'Yes' : 'No'}</p>
                            <p><strong>Plain Text Found:</strong> ${result.plainTextFound ? 'Yes' : 'No'}</p>
                            <p><strong>Hashed Passwords:</strong> ${result.hashedCount}</p>
                            <p><strong>Total Accounts:</strong> ${result.totalAccounts}</p>
                        </div>
                    `;
                    log(`👤 Admin security test: ${result.secure ? 'SECURE' : 'INSECURE'}`, result.secure ? 'success' : 'danger');
                } catch (error) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="bi bi-x-circle-fill"></i> Admin Security Test Error</h6>
                            <p>${error.message}</p>
                        </div>
                    `;
                    log(`❌ Admin security test error: ${error.message}`, 'danger');
                }
            } else {
                resultsDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle"></i> Admin Security Test Unavailable</h6>
                        <p>testAdminPasswordSecurity function not available</p>
                    </div>
                `;
                log(`⚠️ testAdminPasswordSecurity function not available`, 'warning');
            }
        }

        function runSecurityAudit() {
            const resultsDiv = document.getElementById('securityAuditResults');
            
            if (typeof window.securityAudit === 'function') {
                try {
                    const audit = window.securityAudit();
                    let html = '<div class="alert alert-info"><h6><i class="bi bi-shield-check"></i> Security Audit Results</h6>';
                    
                    audit.forEach((item, index) => {
                        const statusClass = item.status === 'PASS' ? 'success' : item.status === 'WARN' ? 'warning' : 'danger';
                        const statusIcon = item.status === 'PASS' ? 'check-circle-fill' : item.status === 'WARN' ? 'exclamation-triangle-fill' : 'x-circle-fill';
                        
                        html += `
                            <div class="mb-2">
                                <strong>${index + 1}. ${item.category}:</strong>
                                <span class="badge bg-${statusClass} ms-2">
                                    <i class="bi bi-${statusIcon}"></i> ${item.status}
                                </span>
                                <p class="mb-1">${item.message}</p>
                                ${item.details ? `<small class="text-muted">${item.details}</small>` : ''}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    resultsDiv.innerHTML = html;
                    log(`🔍 Security audit completed: ${audit.length} checks`, 'info');
                } catch (error) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="bi bi-x-circle-fill"></i> Security Audit Error</h6>
                            <p>${error.message}</p>
                        </div>
                    `;
                    log(`❌ Security audit error: ${error.message}`, 'danger');
                }
            } else {
                resultsDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle"></i> Security Audit Unavailable</h6>
                        <p>securityAudit function not available</p>
                    </div>
                `;
                log(`⚠️ securityAudit function not available`, 'warning');
            }
        }

        function testFirebaseSecurity() {
            const resultsDiv = document.getElementById('securityAuditResults');
            
            if (typeof window.testFirebaseSecurity === 'function') {
                try {
                    const result = window.testFirebaseSecurity();
                    resultsDiv.innerHTML = `
                        <div class="alert alert-${result.accessible ? 'success' : 'danger'}">
                            <h6><i class="bi bi-${result.accessible ? 'check-circle-fill' : 'x-circle-fill'}"></i> Firebase Security Rules Test</h6>
                            <p><strong>Tenant Access:</strong> ${result.accessible ? 'Allowed' : 'Blocked'}</p>
                            <p><strong>Root Access:</strong> ${result.rootAccess ? 'Allowed' : 'Blocked'}</p>
                            <p><strong>Error:</strong> ${result.error || 'None'}</p>
                        </div>
                    `;
                    log(`🔥 Firebase security test: ${result.accessible ? 'ACCESSIBLE' : 'BLOCKED'}`, result.accessible ? 'success' : 'danger');
                } catch (error) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="bi bi-x-circle-fill"></i> Firebase Security Test Error</h6>
                            <p>${error.message}</p>
                        </div>
                    `;
                    log(`❌ Firebase security test error: ${error.message}`, 'danger');
                }
            } else {
                resultsDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle"></i> Firebase Security Test Unavailable</h6>
                        <p>testFirebaseSecurity function not available</p>
                    </div>
                `;
                log(`⚠️ testFirebaseSecurity function not available`, 'warning');
            }
        }

        function testFirebaseRulesComprehensive() {
            const resultsDiv = document.getElementById('securityAuditResults');
            resultsDiv.innerHTML = '<div class="alert alert-info">Testing Firebase rules comprehensively...</div>';
            
            if (!window.database) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-x-circle-fill"></i> Firebase Database Not Available</h6>
                        <p>Database connection not established</p>
                    </div>
                `;
                return;
            }
            
            const tests = [];
            let completedTests = 0;
            const totalTests = 6;
            
            function updateResults() {
                if (completedTests < totalTests) return;
                
                let html = '<div class="alert alert-info"><h6><i class="bi bi-shield-check"></i> Comprehensive Firebase Rules Test</h6>';
                
                tests.forEach((test, index) => {
                    const statusClass = test.result === 'PASS' ? 'success' : test.result === 'WARN' ? 'warning' : 'danger';
                    const statusIcon = test.result === 'PASS' ? 'check-circle-fill' : test.result === 'WARN' ? 'exclamation-triangle-fill' : 'x-circle-fill';
                    
                    html += `
                        <div class="mb-2">
                            <strong>${index + 1}. ${test.name}:</strong>
                            <span class="badge bg-${statusClass} ms-2">
                                <i class="bi bi-${statusIcon}"></i> ${test.result}
                            </span>
                            <p class="mb-1">${test.message}</p>
                            ${test.details ? `<small class="text-muted">${test.details}</small>` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
                resultsDiv.innerHTML = html;
                
                const passedTests = tests.filter(t => t.result === 'PASS').length;
                const warningTests = tests.filter(t => t.result === 'WARN').length;
                const failedTests = tests.filter(t => t.result === 'FAIL').length;
                
                log(`🔥 Firebase rules test complete: ${passedTests} passed, ${warningTests} warnings, ${failedTests} failed`, 
                    failedTests > 0 ? 'danger' : warningTests > 0 ? 'warning' : 'success');
            }
            
            // Test 1: Root level access (should be blocked)
            window.database.ref('/').once('value')
                .then(() => {
                    tests.push({
                        name: 'Root Level Access',
                        result: 'WARN',
                        message: 'Root level data is readable',
                        details: 'This may indicate rules are too permissive. Consider blocking root access.'
                    });
                })
                .catch(error => {
                    tests.push({
                        name: 'Root Level Access',
                        result: 'PASS',
                        message: 'Root level access properly blocked',
                        details: error.message
                    });
                })
                .finally(() => {
                    completedTests++;
                    updateResults();
                });
            
            // Test 2: Tenants collection access (should be allowed)
            window.database.ref('tenants').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const tenantIds = Object.keys(data);
                        tests.push({
                            name: 'Tenants Collection Access',
                            result: 'PASS',
                            message: `Tenants collection accessible (${tenantIds.length} tenants found)`,
                            details: `Tenant IDs: ${tenantIds.join(', ')}`
                        });
                    } else {
                        tests.push({
                            name: 'Tenants Collection Access',
                            result: 'WARN',
                            message: 'Tenants collection accessible but empty',
                            details: 'No tenant data found'
                        });
                    }
                })
                .catch(error => {
                    tests.push({
                        name: 'Tenants Collection Access',
                        result: 'FAIL',
                        message: 'Tenants collection access blocked',
                        details: error.message
                    });
                })
                .finally(() => {
                    completedTests++;
                    updateResults();
                });
            
           // Test 3: Specific tenant access (should be allowed)
           window.database.ref('tenants/test_tenant').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const dataTypes = Object.keys(data);
                        tests.push({
                            name: 'Test Tenant Access',
                            result: 'PASS',
                            message: `Test tenant accessible (${dataTypes.length} data types)`,
                            details: `Data types: ${dataTypes.join(', ')}`
                        });
                    } else {
                        tests.push({
                            name: 'Test Tenant Access',
                            result: 'WARN',
                            message: 'Test tenant accessible but empty',
                            details: 'No data found in test tenant'
                        });
                    }
                })
                .catch(error => {
                    tests.push({
                        name: 'Test Tenant Access',
                        result: 'FAIL',
                        message: 'Test tenant access blocked',
                        details: error.message
                    });
                })
                .finally(() => {
                    completedTests++;
                    updateResults();
                });
            
           // Test 4: Cross-tenant access (should be blocked for employees)
           window.database.ref('tenants/other_tenant').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        tests.push({
                            name: 'Cross-Tenant Access',
                            result: 'WARN',
                            message: 'Cross-tenant access allowed',
                            details: 'This may indicate rules are too permissive. Consider implementing tenant isolation.'
                        });
                    } else {
                        tests.push({
                            name: 'Cross-Tenant Access',
                            result: 'PASS',
                            message: 'Cross-tenant access blocked or no data',
                            details: 'Other tenant not accessible or empty'
                        });
                    }
                })
                .catch(error => {
                    tests.push({
                        name: 'Cross-Tenant Access',
                        result: 'PASS',
                        message: 'Cross-tenant access properly blocked',
                        details: error.message
                    });
                })
                .finally(() => {
                    completedTests++;
                    updateResults();
                });
            
            // Test 5: Write access to tenant data
            const testData = {
                id: 'test_' + Date.now(),
                name: 'Firebase Rules Test',
                timestamp: new Date().toISOString()
            };
            
            window.database.ref('tenants/test_tenant/test_data').set(testData)
                .then(() => {
                    tests.push({
                        name: 'Tenant Data Write',
                        result: 'PASS',
                        message: 'Write access to tenant data allowed',
                        details: 'Test data written successfully'
                    });
                    
                    // Clean up test data
                    return window.database.ref('tenants/test_tenant/test_data').remove();
                })
                .catch(error => {
                    tests.push({
                        name: 'Tenant Data Write',
                        result: 'FAIL',
                        message: 'Write access to tenant data blocked',
                        details: error.message
                    });
                })
                .finally(() => {
                    completedTests++;
                    updateResults();
                });
            
            // Test 6: Global data access (tasks, etc.)
            window.database.ref('tasks').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const taskCount = Object.keys(data).length;
                        tests.push({
                            name: 'Global Tasks Access',
                            result: 'PASS',
                            message: `Global tasks accessible (${taskCount} tasks)`,
                            details: 'Task templates are globally accessible'
                        });
                    } else {
                        tests.push({
                            name: 'Global Tasks Access',
                            result: 'WARN',
                            message: 'Global tasks accessible but empty',
                            details: 'No task templates found'
                        });
                    }
                })
                .catch(error => {
                    tests.push({
                        name: 'Global Tasks Access',
                        result: 'FAIL',
                        message: 'Global tasks access blocked',
                        details: error.message
                    });
                })
                .finally(() => {
                    completedTests++;
                    updateResults();
                });
        }

        function testTemporaryPasswordGeneration() {
            const resultsDiv = document.getElementById('loginTestResults');
            
            if (typeof generateTemporaryPassword === 'function') {
                try {
                    const passwords = [];
                    const validPasswords = [];
                    const invalidPasswords = [];
                    
                    // Generate 5 test passwords
                    for (let i = 0; i < 5; i++) {
                        const password = generateTemporaryPassword();
                        passwords.push(password);
                        
                        // Validate each password
                        if (typeof validatePasswordStrength === 'function') {
                            const validation = validatePasswordStrength(password);
                            if (validation.isValid) {
                                validPasswords.push({ password, validation });
                            } else {
                                invalidPasswords.push({ password, validation });
                            }
                        } else {
                            // Fallback validation
                            const isValid = password.length >= 12 && 
                                /[A-Z]/.test(password) && 
                                /[a-z]/.test(password) && 
                                /[0-9]/.test(password) && 
                                /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
                            
                            if (isValid) {
                                validPasswords.push({ password, validation: { isValid: true, strength: 100 } });
                            } else {
                                invalidPasswords.push({ password, validation: { isValid: false, strength: 0 } });
                            }
                        }
                    }
                    
                    const successRate = (validPasswords.length / passwords.length) * 100;
                    const statusClass = successRate === 100 ? 'success' : successRate >= 80 ? 'warning' : 'danger';
                    const statusIcon = successRate === 100 ? 'check-circle-fill' : successRate >= 80 ? 'exclamation-triangle-fill' : 'x-circle-fill';
                    
                    let html = `
                        <div class="alert alert-${statusClass}">
                            <h6><i class="bi ${statusIcon}"></i> Temporary Password Generation Test</h6>
                            <p><strong>Success Rate:</strong> ${successRate.toFixed(1)}% (${validPasswords.length}/${passwords.length})</p>
                            <p><strong>Valid Passwords:</strong> ${validPasswords.length}</p>
                            <p><strong>Invalid Passwords:</strong> ${invalidPasswords.length}</p>
                            <hr>
                            <h6>Generated Passwords:</h6>
                    `;
                    
                    passwords.forEach((password, index) => {
                        const isValid = validPasswords.some(vp => vp.password === password);
                        const strength = isValid ? validPasswords.find(vp => vp.password === password).validation.strength : 0;
                        html += `
                            <div class="mb-2">
                                <strong>Password ${index + 1}:</strong> 
                                <code>${password}</code>
                                <span class="badge bg-${isValid ? 'success' : 'danger'} ms-2">
                                    ${isValid ? 'Valid' : 'Invalid'} ${isValid ? `(${strength}/100)` : ''}
                                </span>
                            </div>
                        `;
                    });
                    
                    if (invalidPasswords.length > 0) {
                        html += '<hr><h6>Validation Errors:</h6>';
                        invalidPasswords.forEach((item, index) => {
                            html += `
                                <div class="mb-1">
                                    <strong>Password ${passwords.indexOf(item.password) + 1}:</strong>
                                    <ul class="mb-0">
                                        ${item.validation.errors ? item.validation.errors.map(error => `<li class="text-danger">${error}</li>`).join('') : '<li class="text-danger">Failed basic validation</li>'}
                                    </ul>
                                </div>
                            `;
                        });
                    }
                    
                    html += '</div>';
                    resultsDiv.innerHTML = html;
                    
                    log(`🔑 Temporary password generation test: ${successRate.toFixed(1)}% success rate`, successRate === 100 ? 'success' : 'warning');
                } catch (error) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="bi bi-x-circle-fill"></i> Temporary Password Generation Test Error</h6>
                            <p>${error.message}</p>
                        </div>
                    `;
                    log(`❌ Temporary password generation test error: ${error.message}`, 'danger');
                }
            } else {
                resultsDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle"></i> Temporary Password Generation Test Unavailable</h6>
                        <p>generateTemporaryPassword function not available</p>
                    </div>
                `;
                log(`⚠️ generateTemporaryPassword function not available`, 'warning');
            }
        }

        // Task ID Display Debugging Functions
        function testTaskDisplayName() {
            const taskId = document.getElementById('testTaskId').value;
            const taskName = document.getElementById('testTaskName').value;
            const resultsDiv = document.getElementById('taskDisplayResults');
            
            log(`🔍 Testing task display name for ID: "${taskId}", Name: "${taskName}"`, 'info');
            
            if (typeof window.getTaskDisplayName === 'function') {
                try {
                    const result = window.getTaskDisplayName(taskName, taskId);
                    
                    resultsDiv.innerHTML = `
                        <div class="alert alert-info">
                            <h6><i class="bi bi-list-task"></i> Task Display Name Test</h6>
                            <p><strong>Input Task ID:</strong> "${taskId}"</p>
                            <p><strong>Input Task Name:</strong> "${taskName || 'None'}"</p>
                            <p><strong>Result:</strong> "${result}"</p>
                            <p><strong>Status:</strong> ${result.includes('[Task ID:') ? '⚠️ Fallback to Task ID' : result.includes('[Unknown') ? '❌ Unknown Task' : '✅ Task Name Found'}</p>
                        </div>
                    `;
                    
                    if (result.includes('[Task ID:')) {
                        log(`⚠️ Task ID fallback used for "${taskId}"`, 'warning');
                    } else if (result.includes('[Unknown')) {
                        log(`❌ Unknown task for "${taskId}"`, 'danger');
                    } else {
                        log(`✅ Task name found: "${result}"`, 'success');
                    }
                } catch (error) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="bi bi-x-circle-fill"></i> Task Display Name Test Error</h6>
                            <p>${error.message}</p>
                        </div>
                    `;
                    log(`❌ Task display name test error: ${error.message}`, 'danger');
                }
            } else {
                resultsDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle"></i> Task Display Name Test Unavailable</h6>
                        <p>getTaskDisplayName function not available</p>
                    </div>
                `;
                log(`⚠️ getTaskDisplayName function not available`, 'warning');
            }
        }

        function loadTaskData() {
            const taskIdsDiv = document.getElementById('availableTaskIds');
            
            log('📋 Loading task data...', 'info');
            
            let taskData = '';
            
            // Check window.tasks
            if (window.tasks && Array.isArray(window.tasks)) {
                taskData += '<h6>Window Tasks:</h6><ul>';
                window.tasks.slice(0, 10).forEach(task => {
                    taskData += `<li><strong>${task.id}</strong>: ${task.name}</li>`;
                });
                taskData += '</ul>';
            } else {
                taskData += '<p><em>Window tasks not available</em></p>';
            }
            
            // Check COMPREHENSIVE_TASKS
            if (window.COMPREHENSIVE_TASKS && Array.isArray(window.COMPREHENSIVE_TASKS)) {
                taskData += '<h6>COMPREHENSIVE_TASKS:</h6><ul>';
                window.COMPREHENSIVE_TASKS.slice(0, 15).forEach(task => {
                    taskData += `<li><strong>${task.id}</strong>: ${task.name}</li>`;
                });
                taskData += '</ul>';
            } else {
                taskData += '<p><em>COMPREHENSIVE_TASKS not available</em></p>';
            }
            
            // Check global tasks variable
            if (typeof tasks !== 'undefined' && Array.isArray(tasks)) {
                taskData += '<h6>Global Tasks:</h6><ul>';
                tasks.slice(0, 10).forEach(task => {
                    taskData += `<li><strong>${task.id}</strong>: ${task.name}</li>`;
                });
                taskData += '</ul>';
            } else {
                taskData += '<p><em>Global tasks variable not available</em></p>';
            }
            
            taskIdsDiv.innerHTML = taskData;
            log(`📋 Task data loaded: ${window.tasks ? window.tasks.length : 0} window tasks, ${window.COMPREHENSIVE_TASKS ? window.COMPREHENSIVE_TASKS.length : 0} comprehensive tasks`, 'info');
        }
    </script>
</body>
</html>

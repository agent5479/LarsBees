<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeeMarshall - Data Migration Tool</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <style>
        /* Hive Aesthetic - Light Yellow, Dark Yellow, White, Black */
        :root {
            --light-yellow: #FFFACD;
            --dark-yellow: #DAA520;
            --white: #FFFFFF;
            --black: #000000;
            --accent: #FFD700;
            --shadow: 0 8px 32px rgba(218, 165, 32, 0.15);
            --radius: 12px;
            --transition: all .22s cubic-bezier(.4,0,.2,1);
        }
        
        body {
            background: var(--light-yellow);
            font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            color: var(--black);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .navbar {
            background: linear-gradient(180deg, var(--white), var(--light-yellow));
            border-bottom: 2px solid var(--dark-yellow);
            box-shadow: var(--shadow);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--black) !important;
            font-size: 1.5rem;
        }
        
        .migration-card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 2px solid var(--dark-yellow);
            transition: var(--transition);
        }
        
        .migration-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(218, 165, 32, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--dark-yellow), var(--accent));
            color: var(--black);
            border: 2px solid var(--dark-yellow);
            font-weight: 600;
            transition: var(--transition);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 12px 28px rgba(218, 165, 32, 0.25);
            background: linear-gradient(135deg, var(--accent), var(--dark-yellow));
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--accent), var(--dark-yellow));
            color: var(--black);
            border: 2px solid var(--accent);
            font-weight: 600;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #90EE90, #32CD32);
            color: var(--black);
            border: 2px solid #32CD32;
            font-weight: 600;
        }
        
        .status-card {
            background: var(--light-yellow);
            border: 2px solid var(--dark-yellow);
            border-radius: var(--radius);
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, var(--dark-yellow), var(--accent));
        }
        
        .text-warning {
            color: var(--dark-yellow) !important;
        }
        
        .text-success {
            color: #32CD32 !important;
        }
        
        .text-danger {
            color: #DC3545 !important;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="beemarshall-full.html">
                <i class="bi bi-hexagon-fill"></i> BeeMarshall - Migration Tool
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="migration-card p-4">
                    <div class="text-center mb-4">
                        <i class="bi bi-arrow-repeat text-warning" style="font-size: 3rem;"></i>
                        <h1 class="h3 mb-2">Data Migration Tool</h1>
                        <p class="text-muted">Migrate Lars' data to the new tenant structure</p>
                    </div>
                    
                    <!-- Migration Status -->
                    <div class="status-card">
                        <h5><i class="bi bi-info-circle"></i> Migration Status</h5>
                        <div id="migrationStatus">
                            <p class="mb-2">Ready to migrate Lars' data to new tenant structure</p>
                            <div class="progress mb-3" style="height: 8px;">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="migrationProgress"></div>
                            </div>
                            <div id="migrationLog"></div>
                        </div>
                    </div>
                    
                    <!-- Migration Controls -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-grid">
                                <button class="btn btn-primary btn-lg" onclick="startMigration()" id="startButton">
                                    <i class="bi bi-play-circle"></i> Start Migration
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-grid">
                                <button class="btn btn-warning btn-lg" onclick="checkDataStatus()" id="checkButton">
                                    <i class="bi bi-search"></i> Check Data Status
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Controls -->
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-info btn-sm" onclick="testFirebaseConnection()">
                                    <i class="bi bi-wifi"></i> Test Firebase Connection
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-success btn-sm" onclick="testFirebaseConfig()">
                                    <i class="bi bi-gear"></i> Test Firebase Config
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-secondary btn-sm" onclick="clearLog()">
                                    <i class="bi bi-trash"></i> Clear Log
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Preview -->
                    <div class="mt-4">
                        <h5><i class="bi bi-eye"></i> Data Preview</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center p-3 border rounded">
                                    <h4 class="text-warning" id="clustersCount">0</h4>
                                    <small>Clusters (Old)</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 border rounded">
                                    <h4 class="text-warning" id="actionsCount">0</h4>
                                    <small>Actions (Old)</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 border rounded">
                                    <h4 class="text-warning" id="tasksCount">0</h4>
                                    <small>Tasks (Old)</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-3 border rounded">
                                    <h4 class="text-warning" id="employeesCount">0</h4>
                                    <small>Employees (Old)</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- New Structure Preview -->
                        <div class="mt-3">
                            <h6><i class="bi bi-arrow-right"></i> New Structure (tenants/lars/)</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded" style="border-color: #32CD32 !important;">
                                        <h4 class="text-success" id="newClustersCount">0</h4>
                                        <small>Clusters (New)</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded" style="border-color: #32CD32 !important;">
                                        <h4 class="text-success" id="newActionsCount">0</h4>
                                        <small>Actions (New)</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded" style="border-color: #32CD32 !important;">
                                        <h4 class="text-success" id="newTasksCount">0</h4>
                                        <small>Tasks (New)</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded" style="border-color: #32CD32 !important;">
                                        <h4 class="text-success" id="newEmployeesCount">0</h4>
                                        <small>Employees (New)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Instructions -->
                    <div class="mt-4">
                        <h5><i class="bi bi-list-check"></i> Instructions</h5>
                        <ol>
                            <li>Click "Check Data Status" to see current data structure</li>
                            <li>Click "Start Migration" to begin the migration process</li>
                            <li>Wait for the migration to complete</li>
                            <li>Return to the main application to verify your data</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration - Updated with correct credentials
        const firebaseConfig = {
            apiKey: "AIzaSyALV0NmXT2VIZBrAR6D7rSnphNljhFIeb0",
            authDomain: "beemarshall-378aa.firebaseapp.com",
            databaseURL: "https://beemarshall-378aa-default-rtdb.firebaseio.com",
            projectId: "beemarshall-378aa",
            storageBucket: "beemarshall-378aa.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let migrationInProgress = false;
        
        // Check data status
        function checkDataStatus() {
            console.log('üîç Checking data status...');
            updateLog('Checking Firebase data structure...', 'info');
            
            let oldDataCount = 0;
            let newDataCount = 0;
            
            // Check old data structure (global paths)
            updateLog('üìä Checking OLD structure (global paths)...', 'info');
            
            database.ref('clusters').once('value', (snapshot) => {
                const clusters = snapshot.val();
                const count = clusters ? Object.keys(clusters).length : 0;
                document.getElementById('clustersCount').textContent = count;
                oldDataCount += count;
                updateLog(`üìÅ /clusters: ${count} records`, count > 0 ? 'warning' : 'info');
                
                if (count > 0) {
                    updateLog(`   Sample cluster keys: ${Object.keys(clusters).slice(0, 3).join(', ')}`, 'info');
                }
            }).catch(error => {
                updateLog(`‚ùå Error reading /clusters: ${error.message}`, 'danger');
                updateLog(`Error code: ${error.code}`, 'danger');
            });
            
            database.ref('actions').once('value', (snapshot) => {
                const actions = snapshot.val();
                const count = actions ? Object.keys(actions).length : 0;
                document.getElementById('actionsCount').textContent = count;
                oldDataCount += count;
                updateLog(`üìÅ /actions: ${count} records`, count > 0 ? 'warning' : 'info');
                
                if (count > 0) {
                    updateLog(`   Sample action keys: ${Object.keys(actions).slice(0, 3).join(', ')}`, 'info');
                }
            }).catch(error => {
                updateLog(`‚ùå Error reading /actions: ${error.message}`, 'danger');
                updateLog(`Error code: ${error.code}`, 'danger');
            });
            
            database.ref('scheduledTasks').once('value', (snapshot) => {
                const tasks = snapshot.val();
                const count = tasks ? Object.keys(tasks).length : 0;
                document.getElementById('tasksCount').textContent = count;
                oldDataCount += count;
                updateLog(`üìÅ /scheduledTasks: ${count} records`, count > 0 ? 'warning' : 'info');
                
                if (count > 0) {
                    updateLog(`   Sample task keys: ${Object.keys(tasks).slice(0, 3).join(', ')}`, 'info');
                }
            }).catch(error => {
                updateLog(`‚ùå Error reading /scheduledTasks: ${error.message}`, 'danger');
                updateLog(`Error code: ${error.code}`, 'danger');
            });
            
            database.ref('employees').once('value', (snapshot) => {
                const employees = snapshot.val();
                const count = employees ? Object.keys(employees).length : 0;
                document.getElementById('employeesCount').textContent = count;
                oldDataCount += count;
                updateLog(`üìÅ /employees: ${count} records`, count > 0 ? 'warning' : 'info');
                
                if (count > 0) {
                    updateLog(`   Sample employee keys: ${Object.keys(employees).slice(0, 3).join(', ')}`, 'info');
                }
            }).catch(error => {
                updateLog(`‚ùå Error reading /employees: ${error.message}`, 'danger');
                updateLog(`Error code: ${error.code}`, 'danger');
            });
            
            // Check new structure (tenant paths)
            setTimeout(() => {
                updateLog('üìä Checking NEW structure (tenant paths)...', 'info');
                
                database.ref('tenants/lars/clusters').once('value', (snapshot) => {
                    const newClusters = snapshot.val();
                    const count = newClusters ? Object.keys(newClusters).length : 0;
                    newDataCount += count;
                    document.getElementById('newClustersCount').textContent = count;
                    updateLog(`üìÅ /tenants/lars/clusters: ${count} records`, count > 0 ? 'success' : 'info');
                });
                
                database.ref('tenants/lars/actions').once('value', (snapshot) => {
                    const newActions = snapshot.val();
                    const count = newActions ? Object.keys(newActions).length : 0;
                    newDataCount += count;
                    document.getElementById('newActionsCount').textContent = count;
                    updateLog(`üìÅ /tenants/lars/actions: ${count} records`, count > 0 ? 'success' : 'info');
                });
                
                database.ref('tenants/lars/scheduledTasks').once('value', (snapshot) => {
                    const newTasks = snapshot.val();
                    const count = newTasks ? Object.keys(newTasks).length : 0;
                    newDataCount += count;
                    document.getElementById('newTasksCount').textContent = count;
                    updateLog(`üìÅ /tenants/lars/scheduledTasks: ${count} records`, count > 0 ? 'success' : 'info');
                });
                
                database.ref('tenants/lars/employees').once('value', (snapshot) => {
                    const newEmployees = snapshot.val();
                    const count = newEmployees ? Object.keys(newEmployees).length : 0;
                    newDataCount += count;
                    document.getElementById('newEmployeesCount').textContent = count;
                    updateLog(`üìÅ /tenants/lars/employees: ${count} records`, count > 0 ? 'success' : 'info');
                });
                
                // Summary
                setTimeout(() => {
                    updateLog(`üìä SUMMARY: ${oldDataCount} records in OLD structure, ${newDataCount} records in NEW structure`, 'info');
                    
                    if (oldDataCount > 0 && newDataCount === 0) {
                        updateLog('‚ö†Ô∏è Migration needed: Data exists in old structure but not in new structure', 'warning');
                    } else if (oldDataCount > 0 && newDataCount > 0) {
                        updateLog('‚úÖ Migration partially complete: Data exists in both structures', 'success');
                    } else if (oldDataCount === 0 && newDataCount > 0) {
                        updateLog('‚úÖ Migration complete: All data moved to new structure', 'success');
                    } else {
                        updateLog('üì≠ No data found in either structure', 'info');
                    }
                }, 2000);
            }, 1500);
        }
        
        // Start migration
        function startMigration() {
            if (migrationInProgress) {
                updateLog('Migration already in progress...', 'warning');
                return;
            }
            
            migrationInProgress = true;
            updateLog('Starting migration process...', 'info');
            
            const startButton = document.getElementById('startButton');
            startButton.disabled = true;
            startButton.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Migrating...';
            
            let migrationSteps = 0;
            const totalSteps = 5;
            
            // Update progress
            function updateProgress(step) {
                migrationSteps = step;
                const progress = (migrationSteps / totalSteps) * 100;
                document.getElementById('migrationProgress').style.width = progress + '%';
            }
            
            // Migrate clusters
            database.ref('clusters').once('value', (snapshot) => {
                const clusters = snapshot.val();
                if (clusters) {
                    updateLog('Migrating clusters...', 'info');
                    return database.ref('tenants/lars/clusters').set(clusters);
                }
            }).then(() => {
                updateLog('‚úÖ Clusters migrated successfully', 'success');
                updateProgress(1);
                
                // Migrate actions
                return database.ref('actions').once('value', (snapshot) => {
                    const actions = snapshot.val();
                    if (actions) {
                        updateLog('Migrating actions...', 'info');
                        return database.ref('tenants/lars/actions').set(actions);
                    }
                });
            }).then(() => {
                updateLog('‚úÖ Actions migrated successfully', 'success');
                updateProgress(2);
                
                // Migrate scheduled tasks
                return database.ref('scheduledTasks').once('value', (snapshot) => {
                    const tasks = snapshot.val();
                    if (tasks) {
                        updateLog('Migrating scheduled tasks...', 'info');
                        return database.ref('tenants/lars/scheduledTasks').set(tasks);
                    }
                });
            }).then(() => {
                updateLog('‚úÖ Scheduled tasks migrated successfully', 'success');
                updateProgress(3);
                
                // Migrate employees
                return database.ref('employees').once('value', (snapshot) => {
                    const employees = snapshot.val();
                    if (employees) {
                        updateLog('Migrating employees...', 'info');
                        return database.ref('tenants/lars/employees').set(employees);
                    }
                });
            }).then(() => {
                updateLog('‚úÖ Employees migrated successfully', 'success');
                updateProgress(4);
                
                // Migrate hives
                return database.ref('hives').once('value', (snapshot) => {
                    const hives = snapshot.val();
                    if (hives) {
                        updateLog('Migrating hives...', 'info');
                        return database.ref('tenants/lars/hives').set(hives);
                    }
                });
            }).then(() => {
                updateLog('‚úÖ Hives migrated successfully', 'success');
                updateProgress(5);
                
                // Migration complete
                updateLog('üéâ Migration completed successfully!', 'success');
                updateLog('You can now return to the main application', 'info');
                
                startButton.innerHTML = '<i class="bi bi-check-circle"></i> Migration Complete';
                startButton.classList.remove('btn-primary');
                startButton.classList.add('btn-success');
                startButton.disabled = false;
                
                migrationInProgress = false;
                
            }).catch(error => {
                updateLog('‚ùå Migration failed: ' + error.message, 'danger');
                startButton.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Migration Failed';
                startButton.classList.remove('btn-primary');
                startButton.classList.add('btn-danger');
                startButton.disabled = false;
                migrationInProgress = false;
            });
        }
        
        // Update log
        function updateLog(message, type) {
            const log = document.getElementById('migrationLog');
            const timestamp = new Date().toLocaleTimeString();
            const alertClass = type === 'info' ? 'alert-info' : 
                              type === 'success' ? 'alert-success' : 
                              type === 'warning' ? 'alert-warning' : 'alert-danger';
            
            log.innerHTML += `<div class="alert ${alertClass} alert-sm mb-1">
                <small>[${timestamp}] ${message}</small>
            </div>`;
            
            // Scroll to bottom
            log.scrollTop = log.scrollHeight;
        }
        
        // Test Firebase connection with enhanced diagnostics
        function testFirebaseConnection() {
            updateLog('Testing Firebase connection...', 'info');
            updateLog('Firebase Config: ' + JSON.stringify(firebaseConfig, null, 2), 'info');
            
            // Check if Firebase is initialized
            if (!firebase.apps.length) {
                updateLog('‚ùå Firebase not initialized', 'danger');
                return;
            }
            
            updateLog('‚úÖ Firebase app initialized', 'success');
            updateLog('Database URL: ' + firebase.app().options.databaseURL, 'info');
            
            // Test connection with timeout
            let connectionTimeout = setTimeout(() => {
                updateLog('‚ùå Firebase connection timeout (10s)', 'danger');
            }, 10000);
            
            database.ref('.info/connected').on('value', (snapshot) => {
                clearTimeout(connectionTimeout);
                if (snapshot.val() === true) {
                    updateLog('‚úÖ Firebase connected successfully', 'success');
                    
                    // Test with a simple read
                    database.ref('master').once('value', (snapshot) => {
                        updateLog('‚úÖ Firebase read test successful', 'success');
                        updateLog('Master data exists: ' + (snapshot.exists() ? 'Yes' : 'No'), 'info');
                    }).catch(error => {
                        updateLog('‚ùå Firebase read test failed: ' + error.message, 'danger');
                        updateLog('Error code: ' + error.code, 'danger');
                    });
                } else {
                    updateLog('‚ùå Firebase connection failed', 'danger');
                }
            });
            
            // Test with a simple write (to test permissions)
            database.ref('test/connection').set({
                timestamp: new Date().toISOString(),
                test: true
            }).then(() => {
                updateLog('‚úÖ Firebase write test successful', 'success');
                // Clean up test data
                database.ref('test/connection').remove();
            }).catch(error => {
                updateLog('‚ùå Firebase write test failed: ' + error.message, 'danger');
                updateLog('Error code: ' + error.code, 'danger');
            });
        }
        
        // Test Firebase configuration
        function testFirebaseConfig() {
            updateLog('Testing Firebase configuration...', 'info');
            
            // Check if Firebase is available
            if (typeof firebase === 'undefined') {
                updateLog('‚ùå Firebase SDK not loaded', 'danger');
                return;
            }
            
            updateLog('‚úÖ Firebase SDK loaded', 'success');
            
            // Check configuration
            updateLog('Configuration check:', 'info');
            updateLog('API Key: ' + (firebaseConfig.apiKey ? 'Set' : 'Missing'), firebaseConfig.apiKey ? 'success' : 'danger');
            updateLog('Auth Domain: ' + firebaseConfig.authDomain, 'info');
            updateLog('Database URL: ' + firebaseConfig.databaseURL, 'info');
            updateLog('Project ID: ' + firebaseConfig.projectId, 'info');
            
            // Try to initialize Firebase
            try {
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                    updateLog('‚úÖ Firebase initialized successfully', 'success');
                } else {
                    updateLog('‚úÖ Firebase already initialized', 'success');
                }
                
                // Test database reference
                const testRef = firebase.database().ref('test');
                updateLog('‚úÖ Database reference created', 'success');
                
                // Test a simple operation
                testRef.once('value', (snapshot) => {
                    updateLog('‚úÖ Database read operation successful', 'success');
                }).catch(error => {
                    updateLog('‚ùå Database read operation failed: ' + error.message, 'danger');
                });
                
            } catch (error) {
                updateLog('‚ùå Firebase initialization failed: ' + error.message, 'danger');
            }
        }
        
        // Clear log
        function clearLog() {
            document.getElementById('migrationLog').innerHTML = '';
            updateLog('Log cleared', 'info');
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateLog('Migration tool ready', 'info');
            testFirebaseConnection();
            setTimeout(() => {
                checkDataStatus();
            }, 2000);
        });
    </script>
</body>
</html>

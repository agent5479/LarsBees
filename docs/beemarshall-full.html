<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeeMarshall - Professional Apiary Logistics</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- BeeMarshall Branding System -->
    <link rel="stylesheet" href="css/brand.css" />
    
    <style>
        /* BeeMarshall Enhanced UI - Following Design Philosophy */
        
        :root {
            /* Hive Design System - Light Yellow, Dark Yellow, White, Black */
            --light-yellow: #FFFACD;
            --dark-yellow: #DAA520;
            --white: #FFFFFF;
            --black: #000000;
            --accent: #FFD700;
            --bg: var(--light-yellow);
            --glass: rgba(255,250,205,0.95);
            --shadow: 0 8px 32px rgba(218,165,32,0.15);
            --radius: 12px;
            --transition: all .22s cubic-bezier(.4,0,.2,1);
            
            /* Hive Color Palette */
            --primary-bg: var(--light-yellow);
            --primary-accent: var(--dark-yellow);
            --secondary-accent: var(--white);
            --text-primary: var(--black);
            --text-secondary: #666666;
            --success: var(--dark-yellow);
            --warning: var(--dark-yellow);
            --danger: #DC3545;
            --info: var(--accent);
            
            /* Enhanced Typography */
            --font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-size-base: 16px;
            --line-height-base: 1.6;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            
            /* Border Radius */
            --border-radius-sm: 0.375rem;
            --border-radius-md: 0.5rem;
            --border-radius-lg: 0.75rem;
            --border-radius-xl: 1rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Enhanced Base Styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100%;
            font-family: var(--font-family);
            background: var(--white);
            color: var(--black);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }
        
        body {
            font-size: var(--font-size-base);
            line-height: var(--line-height-base);
            background: var(--white);
        }
        
        a {
            color: inherit;
            text-decoration: none;
            transition: var(--transition);
        }
        
        a:hover {
            color: var(--accent);
        }
        
        img {
            display: block;
            max-width: 100%;
            height: auto;
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                transition: none !important;
                animation: none !important;
                transform: none !important;
            }
        }

        
        
        /* Enhanced Button Styles */
        .btn {
            border-radius: var(--radius);
            font-weight: 600;
            transition: var(--transition);
            box-shadow: 0 8px 22px rgba(0,0,0,0.1);
        }

        /* Sticky sub-navigation/header used across views */
        .sticky-subnav {
            position: sticky;
            top: 56px; /* keep below navbar */
            z-index: 1010;
            background: #fff;
            padding-top: 6px;
            padding-bottom: 6px;
            border-bottom: 1px solid #eee;
        }

        
        
        .btn-primary {
            background: linear-gradient(135deg, var(--dark-yellow), var(--accent));
            color: var(--black);
            border: 2px solid var(--dark-yellow);
            font-weight: 600;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 12px 28px rgba(218,165,32,0.25);
            background: linear-gradient(135deg, var(--accent), var(--dark-yellow));
        }
        
        .btn-outline-primary {
            background: transparent;
            border: 2px solid var(--dark-yellow);
            color: var(--black);
        }
        
        .btn-outline-primary:hover {
            background: var(--dark-yellow);
            border-color: var(--dark-yellow);
            color: var(--black);
        }
        
        /* Enhanced Card Styles - Migration Tool Aesthetic */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            border: 2px solid var(--dark-yellow);
            box-shadow: 0 8px 32px rgba(218,165,32,0.15);
            transition: var(--transition);
            backdrop-filter: blur(12px) saturate(1.1);
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(218,165,32,0.2);
        }
        
        /* Glass morphism for modals - Migration Tool Aesthetic */
        .modal-content {
            background: var(--white);
            border: 2px solid var(--dark-yellow);
            backdrop-filter: blur(12px) saturate(1.1);
            border-radius: var(--radius);
            box-shadow: 0 8px 32px rgba(218,165,32,0.15);
        }
        
        /* Version Tag Styling */
        .version-tag {
            margin-top: 0.5rem;
        }
        .version-tag .badge {
            background: linear-gradient(135deg, var(--primary-accent), #17a2b8) !important;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: var(--transition);
        }
        .version-tag .badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Map Placeholder Styling */
        .map-placeholder {
            height: 400px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            background-image: 
                linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0,0,0,0.05) 2px,
                    rgba(0,0,0,0.05) 4px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 2px,
                    rgba(0,0,0,0.05) 2px,
                    rgba(0,0,0,0.05) 4px
                );
            background-size: 100% 100%, 100px 100px, 100px 100px;
            background-position: center, 0 0, 0 0;
        }
        
        .map-placeholder:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            border-color: var(--primary-accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .map-placeholder-content {
            text-align: center;
            z-index: 2;
            position: relative;
        }
        
        .map-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(0,0,0,0.02) 10px,
                rgba(0,0,0,0.02) 20px
            );
            z-index: 1;
        }
        
        /* Skeleton map elements */
        .skeleton-map-marker {
            position: absolute;
            width: 24px;
            height: 24px;
            background: var(--primary-accent);
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            border: 2px solid var(--white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            animation: pulse 2s infinite;
        }
        
        .skeleton-map-marker::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            width: 12px;
            height: 12px;
            background: var(--white);
            border-radius: 50%;
        }
        
        .skeleton-map-marker:nth-child(1) {
            top: 25%;
            left: 30%;
        }
        
        .skeleton-map-marker:nth-child(2) {
            top: 40%;
            left: 60%;
        }
        
        .skeleton-map-marker:nth-child(3) {
            top: 55%;
            left: 45%;
        }
        
        .skeleton-map-marker:nth-child(4) {
            top: 70%;
            left: 25%;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: rotate(-45deg) scale(1);
            }
            50% {
                opacity: 0.7;
                transform: rotate(-45deg) scale(1.1);
            }
        }
        
        .map-placeholder-content button {
            position: relative;
            z-index: 3;
        }
        
        .map-placeholder-content i.bi-map {
            position: relative;
            z-index: 3;
        }
        
        /* Enhanced Form Styles */
        .form-control {
            border-radius: var(--radius);
            border: 2px solid var(--dark-yellow);
            transition: var(--transition);
            background: var(--white);
            backdrop-filter: blur(8px);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 0.2rem rgba(218, 165, 32, 0.25);
        }
        
        .form-select {
            border-radius: var(--radius);
            border: 2px solid var(--dark-yellow);
            transition: var(--transition);
            background: var(--white);
            backdrop-filter: blur(8px);
        }
        
        .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 0.2rem rgba(218, 165, 32, 0.25);
        }
        
        /* Collapsible site filter */
        #siteFilterOptions {
            transition: all 0.3s ease;
        }
        
        #siteFilterOptions .btn-group-vertical {
            gap: 0.25rem;
        }
        
        #siteFilterOptions .btn {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
            text-align: left;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        
        #siteFilterOptions .btn:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #filterToggleBtn {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        
        #filterToggleBtn:hover {
            background-color: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            #siteTypeFilter {
                margin-bottom: 1rem;
            }
            
            #siteTypeFilter .form-label {
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }
            
            #siteFilterOptions .btn {
                font-size: 0.8rem;
                padding: 0.35rem 0.7rem;
            }
            
            #filterToggleBtn {
                font-size: 0.8rem;
                padding: 0.35rem 0.7rem;
            }
        }
        
        /* Navigation */
        .navbar {
            background: var(--dark-yellow);
            border-bottom: 2px solid var(--black);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Sticky navbar for mobile */
        @media (max-width: 768px) {
            .navbar {
                position: sticky;
                top: 0;
                z-index: 1040;
            }
        }
        
        .navbar.scrolled {
            background: var(--dark-yellow);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--black) !important;
            font-size: 1.5rem;
        }
        
        .nav-link {
            color: var(--black) !important;
            font-weight: 600;
            position: relative;
            transition: all 0.3s ease;
            border-radius: 4px;
            padding: 0.5rem 1rem !important;
        }
        
        .nav-link:hover {
            color: var(--white) !important;
            background: rgba(255,255,255,0.3);
        }
        
        /* Active navigation state */
        .nav-link.active {
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.5) 100%) !important;
            color: var(--black) !important;
            font-weight: 700 !important;
            border: 2px solid rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .nav-link.active::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, var(--dark-yellow) 50%, transparent 100%);
            border-radius: 2px 2px 0 0;
        }
        
        .nav-link.active i {
            transform: scale(1.1);
        }
        
        /* Dropdown styling */
        .dropdown-menu {
            background: var(--white);
            border: 2px solid var(--dark-yellow);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            padding: 0.5rem 0;
        }
        
        .dropdown-item {
            color: var(--black);
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s ease;
        }
        
        .dropdown-item:hover {
            background: linear-gradient(135deg, var(--light-yellow) 0%, rgba(255,193,7,0.2) 100%);
            color: var(--black);
            transform: translateX(4px);
        }
        
        .dropdown-item i {
            margin-right: 0.5rem;
        }
        
        .dropdown-divider {
            border-color: var(--dark-yellow);
            opacity: 0.3;
            margin: 0.5rem 0;
        }
        
        /* Cards */
        .card {
            border: none;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            background: var(--primary-bg);
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
        }
        
        .card-header {
            background: var(--dark-yellow);
            color: var(--black);
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0 !important;
            font-weight: 600;
        }
        
        /* Buttons */
        .btn {
            border-radius: var(--border-radius-md);
            font-weight: 500;
            border: none;
        }
        
        .btn:hover {
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-accent) 0%, #17a2b8 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--dark-yellow) 0%, var(--accent) 100%);
            color: var(--black);
            border: 2px solid var(--dark-yellow);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #F1C40F 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #E67E22 100%);
        }
        
        /* Forms */
        .form-control, .form-select {
            border-radius: var(--border-radius-md);
            border: 2px solid #E9ECEF;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 0.2rem rgba(31, 200, 222, 0.25);
        }
        
        /* Enhanced Dashboard Stats */
        .dashboard-stat-card {
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
            background: var(--glass);
            backdrop-filter: blur(12px) saturate(1.1);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        .dashboard-stat-card:hover {
            box-shadow: 0 12px 40px rgba(0,0,0,0.1);
            border-color: var(--accent);
        }
        
        .dashboard-stat-card .card-body {
            position: relative;
            z-index: 2;
            padding: 2rem 1.5rem;
        }
        
        .stat-icon-container {
            margin-bottom: 1rem;
            position: relative;
        }
        
        .stat-icon-container i {
            font-size: 3rem;
            transition: all 0.3s ease;
            display: inline-block;
        }
        
        .dashboard-stat-card:hover .stat-icon-container i {
            transform: scale(1.2) rotate(5deg);
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--primary-accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .dashboard-stat-card:hover .stat-number {
            color: var(--primary-accent);
        }
        
        .stat-label {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0;
        }
        
        .dashboard-stat-card:hover .stat-label {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .stat-action-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            opacity: 0;
        }
        
        .dashboard-stat-card:hover .stat-action-indicator {
            opacity: 1;
        }
        
        .stat-action-indicator i {
            font-size: 1.2rem;
            color: var(--primary-accent);
        }
        
        /* Specific card styling */
        .sites-card:hover {
            border-color: var(--primary-accent);
        }
        
        .hives-card:hover {
            border-color: var(--success);
        }
        
        .actions-card:hover {
            border-color: var(--info);
        }
        
        .flagged-card:hover {
            border-color: var(--warning);
        }
        
        /* Static number display */
        .stat-number {
            opacity: 1;
        }
        
        /* Action Items */
        .action-item {
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            margin-bottom: var(--spacing-sm);
            background: var(--primary-bg);
            border-left: 4px solid var(--primary-accent);
        }
        
        .action-item:hover {
            background: var(--secondary-accent);
        }
        
        .action-item.flag-urgent {
            border-left-color: var(--danger);
            background: rgba(231, 76, 60, 0.1);
        }
        
        .action-item.flag-warning {
            border-left-color: var(--warning);
            background: rgba(243, 156, 18, 0.1);
        }
        
        .action-item.flag-info {
            border-left-color: var(--info);
            background: rgba(52, 152, 219, 0.1);
        }
        
        /* Map */
        #map {
            height: 100%;
            min-height: 450px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            background: #f8f9fa;
        }
        
        /* Map loading improvements */
        .leaflet-container {
            background: #f8f9fa !important;
        }
        
        .leaflet-tile {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        
        /* Site popup styling */
        .site-popup {
            min-width: 200px;
        }
        
        .site-popup h6 {
            margin-bottom: 0.5rem;
            color: var(--dark-yellow);
        }
        
        .site-popup p {
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        
        /* Enhanced Calendar Widget */
        .calendar-widget {
            background: var(--primary-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            max-height: 600px;
            overflow-y: auto;
        }
        
        .calendar-summary {
            background: linear-gradient(135deg, var(--secondary-accent) 0%, rgba(31, 200, 222, 0.1) 100%);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            border: 1px solid rgba(31, 200, 222, 0.2);
        }
        
        .summary-item {
            padding: var(--spacing-sm);
        }
        
        /* Weather Widget */
        .weather-content {
            padding: var(--spacing-sm);
        }
        
        .weather-header h6 {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .weather-days {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .weather-day {
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            background: rgba(255, 255, 255, 0.5);
        }
        
        .weather-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            font-size: 0.9rem;
        }
        
        .weather-day-content {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        .weather-icon {
            flex-shrink: 0;
        }
        
        .weather-details {
            flex: 1;
        }
        
        .weather-temp {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .weather-desc {
            text-transform: capitalize;
        }
        
        .weather-extra {
            display: flex;
            gap: var(--spacing-sm);
            opacity: 0.7;
        }
        
        .weather-extra i {
            margin-right: 0.25rem;
        }
        
        .weather-update-time {
            font-size: 0.85rem;
        }
        
        .weather-placeholder {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-md);
            color: var(--text-secondary);
        }
        
        .weather-placeholder i {
            font-size: 3rem;
            margin-bottom: var(--spacing-sm);
        }
        
        .summary-item strong {
            font-size: 1.5rem;
            display: block;
        }
        
        .calendar-date {
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            background: var(--secondary-accent);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .calendar-date:hover {
            background: rgba(31, 200, 222, 0.05);
            border-color: rgba(31, 200, 222, 0.2);
        }
        
        .calendar-date.today {
            background: rgba(31, 200, 222, 0.15);
            border-left: 4px solid var(--primary-accent);
            box-shadow: 0 2px 8px rgba(31, 200, 222, 0.2);
        }
        
        .calendar-date.tomorrow {
            background: rgba(52, 152, 219, 0.15);
            border-left: 4px solid var(--info);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }
        
        .calendar-date.this-week {
            background: rgba(39, 174, 96, 0.1);
            border-left: 4px solid var(--success);
        }
        
        .calendar-date-header {
            margin-bottom: var(--spacing-sm);
        }
        
        .date-badges .badge {
            font-size: 0.7rem;
            margin-left: var(--spacing-xs);
        }
        
        .calendar-task {
            background: var(--primary-bg);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--spacing-xs);
            border: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .calendar-task:hover {
            background: rgba(31, 200, 222, 0.05);
            border-color: rgba(31, 200, 222, 0.3);
            transform: translateX(4px);
        }
        
        .calendar-task.overdue {
            background: rgba(231, 76, 60, 0.1);
            border-left: 3px solid var(--danger);
        }
        
        .calendar-task.overdue:hover {
            background: rgba(231, 76, 60, 0.15);
        }
        
        .task-header {
            display: flex;
            justify-content: between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-xs);
        }
        
        .task-name {
            flex-grow: 1;
            font-size: 0.9rem;
            line-height: 1.3;
        }
        
        .task-details {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        .task-details i {
            margin-right: 0.25rem;
        }
        
        .task-actions {
            margin-left: var(--spacing-sm);
        }
        
        .task-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        /* Reports Styling */
        
        /* Timeline */
        .timeline-container {
            background: var(--primary-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .timeline-date {
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            background: var(--secondary-accent);
        }
        
        .timeline-date.today {
            background: rgba(31, 200, 222, 0.1);
            border-left: 4px solid var(--primary-accent);
        }
        
        .timeline-date.past {
            opacity: 0.7;
        }
        
        .timeline-task {
            background: var(--primary-bg);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--spacing-xs);
        }
        
        .timeline-task.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }
        
        /* Site Cards */
        .site-card {
            transition: all 0.3s ease;
        }
        
        .site-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Custom Site Markers */
        .custom-site-marker {
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
        }
        
        /* Map Popup Styling */
        .site-popup .leaflet-popup-content {
            margin: 0;
            padding: 0;
        }
        
        .site-popup .leaflet-popup-content-wrapper {
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
        }
        
        .site-popup a {
            transition: all 0.3s ease;
        }
        
        .site-popup a:hover {
            text-decoration: underline !important;
            transform: scale(1.05);
        }
        
        .site-popup .btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius-sm);
        }
        
        /* Sync Status */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--dark-yellow);
            border-radius: 20px;
            padding: 8px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            font-size: 0.85rem;
            backdrop-filter: blur(8px);
            opacity: 0.9;
        }
        
        /* Mobile sync indicator positioning */
        @media (max-width: 768px) {
            .sync-indicator {
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                bottom: auto;
                right: auto;
                width: auto;
                min-width: 200px;
                text-align: center;
                z-index: 1030;
            }
            
            /* Ensure sync indicator doesn't overlap with navbar */
            .sync-indicator.syncing,
            .sync-indicator.error {
                top: 90px;
            }
        }
        
        .sync-indicator.syncing {
            background: rgba(255, 193, 7, 0.15);
            border-color: var(--accent);
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .sync-indicator.error {
            background: rgba(220, 53, 69, 0.15);
            border-color: #DC3545;
        }
        
        @keyframes pulse {
            0% { opacity: 0.9; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
            100% { opacity: 0.9; transform: scale(1); }
        }
        
        .flagged-item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        .highlighted {
            animation: pulse 2s infinite;
        }
        
        /* Enhanced Responsive Design */
        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .card {
                margin-bottom: var(--spacing-md);
            }
            
            #map {
                height: 300px;
            }
            
            /* Mobile dashboard cards - 4 column grid */
            .dashboard-stat-card .card-body {
                padding: 1rem 0.75rem;
            }
            
            .stat-icon-container i {
                font-size: 2rem;
            }
            
            .stat-number {
                font-size: 1.75rem;
            }
            
            .stat-label {
                font-size: 0.8rem;
            }
            
            .stat-action-indicator {
                top: 0.75rem;
                right: 0.75rem;
            }
            
            /* Mobile calendar widget */
            .calendar-widget {
                max-height: 400px;
                padding: 1rem;
            }
            
            .calendar-summary {
                padding: 0.75rem;
            }
            
            .summary-item strong {
                font-size: 1.2rem;
            }
            
            .calendar-date {
                padding: 0.75rem;
            }
            
            .calendar-task {
                padding: 0.5rem;
            }
            
            .task-name {
                font-size: 0.8rem;
            }
            
            .task-details {
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 576px) {
            .dashboard-stat-card .card-body {
                padding: 0.75rem 0.5rem;
            }
            
            .stat-icon-container i {
                font-size: 1.5rem;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            .stat-label {
                font-size: 0.7rem;
            }
        }
        
        /* Accessibility improvements */
        .dashboard-stat-card:focus {
            outline: 3px solid var(--primary-accent);
            outline-offset: 2px;
        }
        
        .dashboard-stat-card:focus:not(:focus-visible) {
            outline: none;
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .dashboard-stat-card {
                border: 2px solid var(--text-primary);
            }
            
            .stat-number {
                color: var(--text-primary) !important;
                -webkit-text-fill-color: var(--text-primary) !important;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .dashboard-stat-card,
            .stat-icon-container i,
            .stat-number,
            .stat-label,
            .stat-action-indicator {
                transition: none;
            }
            
            .stat-number {
                animation: none;
            }
        }
        
        /* Hidden class */
        .hidden {
            display: none !important;
        }
        
        /* Employee hidden */
        .employee-hidden {
            display: none !important;
        }
        
        /* Calendar Styles */
        .fc {
            font-family: inherit;
        }
        
        .fc-event {
            border-radius: 4px;
            border: none;
            padding: 2px 4px;
            font-size: 0.85rem;
        }
        
        .fc-event.priority-urgent {
            background-color: #dc3545;
            color: white;
        }
        
        .fc-event.priority-high {
            background-color: #ffc107;
            color: #212529;
        }
        
        .fc-event.priority-normal {
            background-color: #17a2b8;
            color: white;
        }
        
        .fc-event.overdue {
            background-color: #6c757d;
            color: white;
            text-decoration: line-through;
        }
        
        .fc-toolbar {
            margin-bottom: 1rem;
        }
        
        .fc-button {
            background-color: var(--primary-accent);
            border-color: var(--primary-accent);
        }
        
        .fc-button:hover {
            background-color: #17a2b8;
            border-color: #17a2b8;
        }
        
        .fc-button:focus {
            box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
        }
        
        /* Admin badge */
        .admin-badge {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            font-weight: 600;
        }
        
        /* Hexagon Button for Welcome Modal */
        .hexagon-button {
            position: relative;
            width: 120px;
            height: 60px;
            background: #28a745;
            border: none;
            border-radius: 0;
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
            transition: all 0.3s ease;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .hexagon-button:hover {
            background: #218838;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .hexagon-button:active {
            transform: scale(0.95);
        }
        
        .hexagon-content {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        .hexagon-text {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: lowercase;
            letter-spacing: 0.5px;
        }
        
        /* Clickable Hive State Numbers */
        .cursor-pointer {
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        
        .cursor-pointer:hover {
            transform: scale(1.2);
            opacity: 0.8;
        }
        
        .cursor-pointer:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <!-- Sync Status Indicator -->
    <div id="syncIndicator" class="sync-indicator hidden">
        <span id="syncText"></span>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="container-fluid vh-100 d-flex align-items-center justify-content-center" style="background: linear-gradient(135deg, #8B4513 0%, #A0522D 25%, #CD853F 50%, #D2691E 75%, #8B4513 100%);">
        <div class="row w-100">
            <div class="col-md-6 col-lg-4 mx-auto">
                <div class="card shadow-lg" style="background: var(--glass); backdrop-filter: blur(12px) saturate(1.1); border: 1px solid rgba(255,255,255,0.2);">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <i class="bi bi-hexagon-fill" style="font-size: 4rem; color: var(--accent);"></i>
                            <h2 class="mt-3" style="color: var(--brand);">BeeMarshall</h2>
                            <p class="text-muted">Professional Apiary Management System</p>
                            <div class="version-tag">
                                <span class="badge bg-primary" style="font-size: 0.75rem; padding: 0.4rem 0.8rem;">
                                    <i class="bi bi-tag-fill me-1"></i>v1.3
                                </span>
                            </div>
                        </div>
                        
                        <!-- Login Status Messages -->
                        <div id="loginStatus" class="alert alert-info d-none" role="alert">
                            <i class="bi bi-info-circle"></i>
                            <span id="loginStatusText">Checking system status...</span>
                        </div>
                        
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="loginUsername" class="form-label fw-semibold">Username</label>
                                <input type="text" class="form-control" id="loginUsername" required 
                                       placeholder="Enter your username" autocomplete="username">
                            </div>
                            <div class="mb-3">
                                <label for="loginPassword" class="form-label fw-semibold">Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="loginPassword" required 
                                           placeholder="Enter your password" autocomplete="current-password">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility()">
                                        <i id="passwordToggleIcon" class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 py-2" id="loginButton">
                                <span id="loginButtonText">Login</span>
                                <span id="loginSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
                            </button>
                            
                        </form>
                        
                        <div class="mt-4">
                            <div class="text-center">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> 
                                    Contact your administrator for login credentials
                                </small>
                                <div class="mt-2">
                                    <small class="text-muted">
                                    </small>
                                </div>
                            </div>
                            
                            
                            <!-- Debug Panel (hidden in production) -->
                            <div class="mt-3" id="debugSection" style="display: none;">
                                <button class="btn btn-sm btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#debugPanel">
                                    <i class="bi bi-bug"></i> Debug Information
                                </button>
                                <div class="collapse mt-2" id="debugPanel">
                                    <div class="card card-body bg-light">
                                        <small>
                                            <strong>System Status:</strong> <span id="systemStatus">Checking...</span><br>
                                            <strong>Firebase:</strong> <span id="firebaseStatus">Connecting...</span><br>
                                            <strong>Last Error:</strong> <span id="lastError">None</span><br>
                                            <strong>Session:</strong> <span id="sessionInfo">Not logged in</span><br>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
            <div class="container-fluid">
                <!-- Logo/Brand -->
                <a class="navbar-brand" href="#" onclick="showDashboard()">
                    <i class="bi bi-hexagon-fill"></i> BeeMarshall
                </a>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <!-- Primary Navigation -->
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showDashboard()">
                                <i class="bi bi-house"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSites()">
                                <i class="bi bi-geo-alt"></i> Sites
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showActions()">
                                <i class="bi bi-list-check"></i> Actions
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showScheduledTasks()">
                                <i class="bi bi-calendar3"></i> Schedule
                            </a>
                        </li>
                        <li class="nav-item admin-only">
                            <a class="nav-link" href="#" onclick="showTasks()">
                                <i class="bi bi-list-task"></i> Tasks
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showComplianceView()">
                                <i class="bi bi-shield-check"></i> Compliance
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showIntegrityCheck()">
                                <i class="bi bi-clipboard-data"></i> Data Integrity
                            </a>
                        </li>
                        <li class="nav-item admin-only">
                            <a class="nav-link" href="#" onclick="showEmployees()">
                                <i class="bi bi-people"></i> Team
                            </a>
                        </li>
                        <!-- Move Reports to the end, with a faded aesthetic -->
                        <li class="nav-item">
                            <a class="nav-link opacity-50" href="reports.html" target="_blank" title="Reports (opens in new tab)">
                                <i class="bi bi-graph-up"></i> Reports
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Right Side Navigation -->
                    <ul class="navbar-nav ms-auto align-items-center">
                        <!-- Help/Documentation -->
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showHelpModal()" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Help & Documentation">
                                <i class="bi bi-question-circle"></i>
                                <span class="d-none d-md-inline ms-1">Help</span>
                            </a>
                        </li>
                        
                        <!-- User Profile Dropdown -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-person-circle"></i>
                                <span class="d-none d-md-inline ms-1">
                                    <span id="currentUserDisplay"></span>
                                    <span id="adminBadge" class="badge admin-badge ms-2 hidden">ADMIN</span>
                                </span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li>
                                    <a class="dropdown-item" href="#" onclick="showSettingsModal()">
                                        <i class="bi bi-gear"></i> Settings
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="showProfileModal()">
                                        <i class="bi bi-person"></i> Profile
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="logout()">
                                        <i class="bi bi-box-arrow-right"></i> Logout
                                    </a>
                                </li>
                            </ul>
                        </li>
                        
                        <!-- Sync Status -->
                        <li class="nav-item">
                            <span id="syncStatus" class="navbar-text me-3">
                                <i class="bi bi-wifi text-warning"></i> Online
                            </span>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid mt-4">
            <!-- Dashboard View -->
            <div id="dashboardView">
                <!-- Dashboard Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h1 class="h3 mb-1">Dashboard Overview</h1>
                                <p class="text-muted mb-0">Monitor your apiary operations and key metrics</p>
                            </div>
                            <div>
                                <!-- GBTech Test Service Buttons (only visible for GBTech) -->
                                <span id="gbtechTestButtons" style="display: none;">
                                    <button class="btn btn-success me-2" onclick="createGBTechTestData()">
                                        <i class="bi bi-flask"></i> Create Test Data
                                    </button>
                                    <button class="btn btn-danger me-2" onclick="undoGBTechTestData()">
                                        <i class="bi bi-arrow-counterclockwise"></i> Undo Test Data
                                    </button>
                                </span>
                                <button class="btn btn-warning me-2" onclick="forceMigrateLarsData()" id="migrationButton" style="display: none;">
                                    <i class="bi bi-arrow-repeat"></i> Migrate Lars Data
                                </button>
                                <button class="btn btn-primary" onclick="showScheduleTaskModal()">
                                    <i class="bi bi-plus"></i> Quick Schedule
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Metrics Row - 4 Column Grid -->
                <div class="row g-2 mb-4">
                    <div class="col-6 col-sm-3 mb-2">
                        <div class="card dashboard-stat-card sites-card" onclick="showSites()" data-target="sites">
                            <div class="card-body text-center position-relative">
                                <div class="stat-icon-container">
                                    <i class="bi bi-geo-alt-fill text-primary"></i>
                                </div>
                                <h3 id="statSites" class="stat-number">0</h3>
                                <p class="stat-label">Total Sites</p>
                                <div class="stat-action-indicator">
                                    <i class="bi bi-arrow-right-circle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-3 mb-2">
                        <div class="card dashboard-stat-card hives-card" onclick="showSites()" data-target="sites">
                            <div class="card-body text-center position-relative">
                                <div class="stat-icon-container">
                                    <i class="bi bi-hexagon-fill text-warning"></i>
                                </div>
                                <h3 id="statHives" class="stat-number">0</h3>
                                <p class="stat-label">Total Hives</p>
                                <div class="stat-action-indicator">
                                    <i class="bi bi-arrow-right-circle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-3 mb-2">
                        <div class="card dashboard-stat-card actions-card" onclick="showActions()" data-target="actions">
                            <div class="card-body text-center position-relative">
                                <div class="stat-icon-container">
                                    <i class="bi bi-list-check text-info"></i>
                                </div>
                                <h3 id="statActions" class="stat-number">0</h3>
                                <p class="stat-label">Total Actions</p>
                                <div class="stat-action-indicator">
                                    <i class="bi bi-arrow-right-circle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-3 mb-2">
                        <div class="card dashboard-stat-card flagged-card" onclick="showFlagged()" data-target="flagged">
                            <div class="card-body text-center position-relative">
                                <div class="stat-icon-container">
                                    <i class="bi bi-flag-fill text-warning"></i>
                                </div>
                                <h3 id="statFlagged" class="stat-number">0</h3>
                                <p class="stat-label">Flagged Issues</p>
                                <div class="stat-action-indicator">
                                    <i class="bi bi-arrow-right-circle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Row -->
                <div class="row">
                    <!-- Map Section - Desktop Grid Layout -->
                    <div class="col-lg-12 mb-4">
                        <div class="row g-3">
                            <!-- Map on Left -->
                            <div class="col-lg-7">
                                <div class="card h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="bi bi-map"></i> Site Locations</h5>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary" onclick="showSites()">
                                                <i class="bi bi-geo-alt"></i> Manage Sites
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body p-0" style="min-height: 450px;">
                                        <!-- Map Placeholder (Skeleton Preview) -->
                                        <div id="mapPlaceholder" class="map-placeholder" onclick="activateMap()">
                                            <!-- Skeleton map markers -->
                                            <div class="skeleton-map-marker"></div>
                                            <div class="skeleton-map-marker"></div>
                                            <div class="skeleton-map-marker"></div>
                                            <div class="skeleton-map-marker"></div>
                                            
                                            <div class="map-placeholder-content">
                                                <i class="bi bi-map" style="font-size: 3rem; color: #6c757d;"></i>
                                                <h6 class="mt-3 text-muted">Interactive Map Preview</h6>
                                                <p class="text-muted small">Click anywhere to load your apiary map</p>
                                                <button class="btn btn-outline-primary btn-sm mt-2">
                                                    <i class="bi bi-play-circle me-1"></i>Initialize Map
                                                </button>
                                            </div>
                                        </div>
                                        <!-- Actual Map (Hidden Initially) -->
                                        <div id="map" style="height: 100%; min-height: 350px; display: none;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Upcoming Tasks and Quick Stats on Right -->
                            <div class="col-lg-5">
                                <div class="row g-3 h-100">
                                    <!-- Calendar Widget -->
                                    <div class="col-12">
                                        <div class="card h-100">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0"><i class="bi bi-calendar-week"></i> Upcoming Tasks</h5>
                                                <button class="btn btn-sm btn-outline-primary" onclick="showScheduledTasks()">
                                                    <i class="bi bi-calendar3"></i> View All
                                                </button>
                                            </div>
                                            <div class="card-body">
                                                <div id="calendarWidget">
                                                    <p class="text-muted">Loading calendar...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Row -->
                <div class="row">
                    <!-- Recent Actions with Quick Stats -->
                    <div class="col-lg-8 mb-4">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Actions</h5>
                                <button class="btn btn-sm btn-outline-primary" onclick="showActions()">
                                    <i class="bi bi-list-check"></i> View All
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Quick Stats Section (Nested inside Recent Actions) -->
                                <div class="card bg-light mb-3">
                                    <div class="card-body py-2">
                                        <div class="row text-center g-2">
                                            <div class="col-3">
                                                <div class="quick-stat">
                                                    <h6 class="text-primary mb-0" id="statThisWeek">0</h6>
                                                    <small class="text-muted">This Week</small>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="quick-stat">
                                                    <h6 class="text-success mb-0" id="statCompleted">0</h6>
                                                    <small class="text-muted">Completed</small>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="quick-stat">
                                                    <h6 class="text-warning mb-0" id="statPending">0</h6>
                                                    <small class="text-muted">Pending</small>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="quick-stat">
                                                    <h6 class="text-danger mb-0" id="statOverdue">0</h6>
                                                    <small class="text-muted">Overdue</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Recent Actions List -->
                                <div id="recentActions">
                                    <p class="text-muted">Loading actions...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Flagged Items Alert -->
                <div id="flaggedAlert" class="alert alert-warning hidden">
                    <h6><i class="bi bi-exclamation-triangle"></i> Urgent Items Require Attention</h6>
                    <div id="flaggedItemsList"></div>
                </div>
            </div>

            <!-- Sites View -->
            <div id="sitesView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-geo-alt"></i> Apiary Sites</h2>
                    <div>
                        <button class="btn btn-outline-success me-2" onclick="exportSitesCSV()">
                            <i class="bi bi-download"></i> Export CSV
                        </button>
                        <button class="btn btn-primary admin-only" onclick="showAddSiteForm()">
                            <i class="bi bi-plus"></i> Add Site
                        </button>
                    </div>
                </div>
                
                <div id="functionalClassificationFilter" class="mb-4"></div>
                
                <div class="row" id="sitesList">
                    <div class="text-center my-5">
                        <i class="bi bi-geo-alt" style="font-size: 3rem; color: #ccc;"></i>
                        <h5 class="mt-3 text-muted">No sites yet</h5>
                        <p class="text-muted">Get started by adding your first apiary location</p>
                        <button class="btn btn-primary admin-only" onclick="showAddSiteForm()">
                            <i class="bi bi-plus"></i> Add Your First Site
                        </button>
                    </div>
                </div>
                
                <!-- Show Archived Sites Button -->
                <div class="text-center mt-4">
                    <button class="btn btn-outline-secondary" id="toggleArchivedButton" onclick="toggleArchivedSites()">
                        <i class="bi bi-archive"></i> Show Archived Sites
                    </button>
                </div>
            </div>

            <!-- Site Form View -->
            <div id="siteFormView" class="hidden">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="card">
                            <div class="card-header">
                                <h5 id="siteFormTitle">Add New Site</h5>
                            </div>
                            <div class="card-body">
                                <form id="siteForm">
                                    <input type="hidden" id="siteId">
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="siteName" class="form-label">Site Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="siteName" required placeholder="e.g., Main Apiary, North Field">
                                            <div class="form-text">Give your apiary location a descriptive name</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="functionalClassification" class="form-label">Functional Classification <span class="text-danger">*</span></label>
                                            <select class="form-select" id="functionalClassification" required>
                                                <option value="">Select functional classification...</option>
                                                <option value="production">Production</option>
                                                <option value="nucleus">NUC (Nucleus)</option>
                                                <option value="queen-rearing">Queen Rearing</option>
                                                <option value="research">Research</option>
                                                <option value="education">Education</option>
                                                <option value="quarantine">Quarantine</option>
                                                <option value="backup">Backup</option>
                                                <option value="custom">Custom</option>
                                            </select>
                                            <div class="form-text">Choose the primary purpose of this apiary location</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="seasonalClassification" class="form-label">Seasonal Classification</label>
                                            <select class="form-select" id="seasonalClassification">
                                                <option value="summer">Summer Site</option>
                                                <option value="winter">Winter Site</option>
                                                <option value="all-year">All Year Round</option>
                                            </select>
                                            <div class="form-text">When is this site primarily used?</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="siteDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="siteDescription" rows="3"></textarea>
                                    </div>
                                    
                                    <!-- Hive State Summary -->
                                    <div class="card mt-4" id="hiveStateCard" style="display: none;">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="bi bi-heart-pulse"></i> Hive State</h6>
                                            <small class="text-muted">Click numbers to update counts. Changes are automatically saved.</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-2">
                                                <div class="col-6 col-md-4 text-center">
                                                    <h3 class="mb-1 fw-bold text-success cursor-pointer" id="hiveStateStrong" onclick="editHiveStateCount('Strong')">0</h3>
                                                    <small class="text-muted">Strong</small>
                                                </div>
                                                <div class="col-6 col-md-4 text-center">
                                                    <h3 class="mb-1 fw-bold text-warning cursor-pointer" id="hiveStateMedium" onclick="editHiveStateCount('Medium')">0</h3>
                                                    <small class="text-muted">Medium</small>
                                                </div>
                                                <div class="col-6 col-md-4 text-center">
                                                    <h3 class="mb-1 fw-bold text-danger cursor-pointer" id="hiveStateWeak" onclick="editHiveStateCount('Weak')">0</h3>
                                                    <small class="text-muted">Weak</small>
                                                </div>
                                                <div class="col-6 col-md-4 text-center">
                                                    <h3 class="mb-1 fw-bold text-info cursor-pointer" id="hiveStateNUC" onclick="editHiveStateCount('NUC')">0</h3>
                                                    <small class="text-muted">NUC</small>
                                                </div>
                                                <div class="col-6 col-md-4 text-center">
                                                    <h3 class="mb-1 fw-bold text-dark cursor-pointer" id="hiveStateDead" onclick="editHiveStateCount('Dead')">0</h3>
                                                    <small class="text-muted">Dead</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Hive Boxes -->
                                    <div class="card mt-4">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="bi bi-grid"></i> Hive Boxes</h6>
                                            <small class="text-muted">Click boxes to update site inventory. Changes are automatically saved as actions.</small>
                                        </div>
                                        <div class="card-body">
                                            <div id="visualHiveGrid" class="mb-3">
                                                <p class="text-muted text-center">Loading visual hive grid...</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- GPS and Map Selection Options -->
                                    <div class="mb-3">
                                        <div class="btn-group w-100" role="group">
                                            <button type="button" class="btn btn-outline-primary" id="useLocationBtn">
                                                <i class="bi bi-crosshair"></i> Use Current GPS Location
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="showMapPicker()">
                                                <i class="bi bi-map"></i> Click on Map to Select
                                            </button>
                                        </div>
                                        <div class="form-text text-muted mt-2">
                                            <i class="bi bi-info-circle"></i> Use GPS to auto-fill your current location, or click the map to pick a location interactively
                                        </div>
                                    </div>
                                    
                                    <!-- Map Picker Container (hidden by default) -->
                                    <div id="mapPickerContainer" class="mb-3 hidden">
                                        <div id="mapPicker" style="height: 300px; border-radius: 8px;"></div>
                                        <div class="form-text text-muted mt-2">
                                            <i class="bi bi-info-circle"></i> Click on the map or drag the marker to set GPS coordinates
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="siteLat" class="form-label">Latitude <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="siteLat" step="0.000001" min="-90" max="90" placeholder="-40.6764" required>
                                            <div class="form-text">Enter latitude (e.g., -40.6764 for Collingwood, NZ)</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="siteLng" class="form-label">Longitude <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="siteLng" step="0.000001" min="-180" max="180" placeholder="172.6856" required>
                                            <div class="form-text">Enter longitude (e.g., 172.6856 for Collingwood, NZ)</div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="siteHiveCount" class="form-label">Total Hive Count *</label>
                                            <input type="number" class="form-control" id="siteHiveCount" min="0" required onchange="updateHiveStrengthTotals()">
                                            <div class="form-text">Total number of hives in this site (0 allowed for Summer Only/Winter Only sites)</div>
                                        </div>
                                    </div>
                                    

                                            
                                            <!-- Stack Configuration Summary -->
                                            <div class="row mt-3" id="stackBreakdownSummary" style="display: none;">
                                                <div class="col-12">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h6 class="mb-0"><i class="bi bi-stack"></i> Stack Configuration Summary</h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="row">
                                                                <div class="col-md-4">
                                                                    <div class="text-center">
                                                                        <h5 class="text-primary" id="doublesCount">0</h5>
                                                                        <small class="text-muted">Double Stacks</small>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <div class="text-center">
                                                                        <h5 class="text-success" id="topSplitsCount">0</h5>
                                                                        <small class="text-muted">Top-Splits</small>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <div class="text-center">
                                                                        <h5 class="text-warning" id="singlesCount">0</h5>
                                                                        <small class="text-muted">Single Stacks</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row mt-3">
                                                                <div class="col-md-6">
                                                                    <div class="text-center">
                                                                        <h5 class="text-info" id="nucsCount">0</h5>
                                                                        <small class="text-muted">NUC Stacks</small>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <div class="text-center">
                                                                        <h5 class="text-secondary" id="emptyStacksCount">0</h5>
                                                                        <small class="text-muted">Empty Platforms</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Site Classification -->
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6><i class="bi bi-geo"></i> Site Classification</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="siteType" class="form-label">Site Type</label>
                                                    <select class="form-select" id="siteType">
                                                        <option value="">Select site type...</option>
                                                        <option value="summer">Summer Site</option>
                                                        <option value="winter">Winter Site</option>
                                                        <option value="summer-only">Summer Only</option>
                                                        <option value="winter-only">Winter Only</option>
                                                        <option value="year-round">Year-round Site</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="accessType" class="form-label">Access Type</label>
                                                    <select class="form-select" id="accessType">
                                                        <option value="">Select access type...</option>
                                                        <option value="all-weather">All Weather</option>
                                                        <option value="dry-only">Dry Only</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="contactBeforeVisit">
                                                        <label class="form-check-label" for="contactBeforeVisit">
                                                            Contact Landowner Before Visit
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="isQuarantine">
                                                        <label class="form-check-label" for="isQuarantine">
                                                            Quarantine Site
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Landowner Information -->
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6><i class="bi bi-person"></i> Landowner Information</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="landownerName" class="form-label">Name</label>
                                                    <input type="text" class="form-control" id="landownerName">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="landownerPhone" class="form-label">Phone</label>
                                                    <input type="tel" class="form-control" id="landownerPhone">
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="landownerEmail" class="form-label">Email</label>
                                                    <input type="email" class="form-control" id="landownerEmail">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="landownerAddress" class="form-label">Address</label>
                                                    <input type="text" class="form-control" id="landownerAddress">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Honey Potentials -->
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6><i class="bi bi-flower1"></i> Honey Potentials</h6>
                                        </div>
                                        <div class="card-body">
                                            <p class="small text-muted mb-3">Select likely honey types for this location. Manage the list of available honey types in Task Management.</p>
                                            <div id="honeyPotentialsContainer" class="d-flex flex-wrap gap-2">
                                                <!-- Honey type checkboxes will be dynamically generated here -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="siteHarvest" class="form-label">Expected Harvest Date</label>
                                            <input type="date" class="form-control" id="siteHarvest">
                                            <div class="form-text">Date when honey harvest is expected</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="siteSugar" class="form-label">Sugar Requirements</label>
                                            <input type="text" class="form-control" id="siteSugar" placeholder="e.g., 20kg for winter">
                                        </div>
                                    </div>
                                    
                                    <!-- Historical Harvest Records -->
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6><i class="bi bi-archive"></i> Historical Harvest Records</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="harvestRecordsContainer">
                                                <p class="text-muted small">No harvest records yet. Add your first harvest below.</p>
                                            </div>
                                            <hr>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <label for="harvestDate" class="form-label">Harvest Date</label>
                                                    <input type="date" class="form-control" id="harvestDate">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="harvestQuantity" class="form-label">Quantity (kg)</label>
                                                    <input type="number" step="0.1" class="form-control" id="harvestQuantity" placeholder="e.g., 25.5">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="harvestNotes" class="form-label">Notes</label>
                                                    <input type="text" class="form-control" id="harvestNotes" placeholder="e.g., Late harvest due to weather">
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-outline-success btn-sm mt-2" onclick="addHarvestRecord()">
                                                <i class="bi bi-plus"></i> Add Harvest Record
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="siteNotes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="siteNotes" rows="3"></textarea>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check"></i> Save Site
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="showSites()">
                                            <i class="bi bi-x"></i> Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions View -->
            <div id="actionsView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-list-check"></i> Actions</h2>
                    <div>
                        <button class="btn btn-outline-success me-2" onclick="exportActionsCSV()">
                            <i class="bi bi-download"></i> Export CSV
                        </button>
                        <button class="btn btn-primary" onclick="showLogActionForm()">
                            <i class="bi bi-plus"></i> Log Action
                        </button>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <select class="form-select" id="filterSite">
                            <option value="">All Sites</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterCategory">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterEmployee">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100" onclick="renderActions()">
                            <i class="bi bi-funnel"></i> Apply Filters
                        </button>
                    </div>
                </div>
                
                <!-- Action Type Filters -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-funnel"></i> Hide Action Types</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="hideDeletes" onchange="renderActions()">
                                            <label class="form-check-label" for="hideDeletes">
                                                <i class="bi bi-trash text-danger"></i> Hide Deletes
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="hideMoves" onchange="renderActions()">
                                            <label class="form-check-label" for="hideMoves">
                                                <i class="bi bi-arrow-right text-info"></i> Hide Moves
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="hideStackUpdates" onchange="renderActions()">
                                            <label class="form-check-label" for="hideStackUpdates">
                                                <i class="bi bi-stack text-warning"></i> Hide Inventory Updates
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="hideStrengthUpdates" onchange="renderActions()">
                                            <label class="form-check-label" for="hideStrengthUpdates">
                                                <i class="bi bi-hexagon text-success"></i> Hide Hive Strength Updates
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="actionsList">
                    <div class="text-center my-5">
                        <i class="bi bi-list-check" style="font-size: 3rem; color: #ccc;"></i>
                        <h5 class="mt-3 text-muted">No actions logged yet</h5>
                        <p class="text-muted">Start by logging your first inspection or treatment</p>
                        <button class="btn btn-primary" onclick="showAddActionForm()">
                            <i class="bi bi-plus"></i> Log Your First Action
                        </button>
                    </div>
                </div>
            </div>

            <!-- Log Action Form View -->
            <div id="logActionView" class="hidden">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="bi bi-plus-circle"></i> Log New Action</h5>
                            </div>
                            <div class="card-body">
                                <form id="actionForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="actionSite" class="form-label">Site *</label>
                                            <select class="form-select" id="actionSite" required onchange="loadSiteHives()">
                                                <option value="">Select site...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="actionDate" class="form-label">Date *</label>
                                            <input type="date" class="form-control" id="actionDate" required>
                                        </div>
                                    </div>
                                    
                                    <div id="individualHiveSelect" class="mb-3 hidden">
                                        <label for="actionHive" class="form-label">Specific Hive (Optional)</label>
                                        <select class="form-select" id="actionHive">
                                            <option value="">All hives in site</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Tasks Performed *</label>
                                        <div class="mb-2">
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="filterTaskCheckboxes('common')">
                                                <i class="bi bi-star"></i> Common Tasks
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="filterTaskCheckboxes('all')">
                                                <i class="bi bi-list"></i> All Tasks
                                            </button>
                                        </div>
                                        <div id="taskCheckboxes"></div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="actionFlag" class="form-label">Flag</label>
                                            <select class="form-select" id="actionFlag">
                                                <option value="">No flag</option>
                                                <option value="info">Info</option>
                                                <option value="warning">Warning</option>
                                                <option value="urgent">Urgent</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="actionNotes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="actionNotes" rows="3"></textarea>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check"></i> Log Action
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="showActions()">
                                            <i class="bi bi-x"></i> Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scheduled Tasks View -->
            <div id="scheduledView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-calendar3"></i> Scheduled Tasks</h2>
                    <div>
                        <button class="btn btn-outline-primary me-2" onclick="toggleCalendarView()" id="calendarToggleBtn">
                            <i class="bi bi-calendar3"></i> Calendar View
                        </button>
                        <button class="btn btn-primary" onclick="showScheduleForNextVisit()">
                            <i class="bi bi-calendar-plus"></i> Schedule New Task
                        </button>
                        <button class="btn btn-outline-success ms-2" onclick="generateCalendarFeed()">
                            <i class="bi bi-download"></i> Export Calendar
                        </button>
                        <button class="btn btn-outline-primary ms-2" onclick="copyCalendarFeedLink()">
                            <i class="bi bi-link-45deg"></i> Copy Feed Link
                        </button>
                        <button class="btn btn-outline-info ms-2" onclick="showCalendarSubscriptionInstructions()">
                            <i class="bi bi-calendar-plus"></i> Subscribe to Calendar
                        </button>
                    </div>
                </div>
                
                <div class="d-flex flex-wrap gap-2" style="display:none;">
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleCalendarView()">
                            <i class="bi bi-calendar3"></i> Calendar View
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="showScheduleForNextVisit()">
                            <i class="bi bi-calendar-plus"></i> Schedule New Task
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="generateCalendarFeed()">
                            <i class="bi bi-download"></i> Export Calendar
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="copyCalendarFeedLink()">
                            <i class="bi bi-link-45deg"></i> Copy Feed Link
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="showCalendarSubscriptionInstructions()">
                            <i class="bi bi-calendar-plus"></i> Subscribe
                        </button>
                    </div>
                </div>
                
                <!-- Calendar View -->
                <div id="calendarView" class="hidden mb-4">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-calendar3"></i> Task Calendar</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="exportToGoogleCalendar()">
                                    <i class="bi bi-google"></i> Export to Google Calendar
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyCalendarFeedLink()">
                                    <i class="bi bi-link-45deg"></i> Copy Calendar Feed
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="taskCalendar"></div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="bi bi-list-check"></i> Scheduled Tasks</h5>
                            </div>
                            <div class="card-body">
                                <div id="scheduledTasksList">
                                    <p class="text-muted">Loading scheduled tasks...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="bi bi-timeline"></i> Timeline</h5>
                            </div>
                            <div class="card-body">
                                <div id="scheduleTimeline">
                                    <p class="text-muted">Loading timeline...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule for Next Visit View -->
            <div id="scheduleForNextVisitView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-calendar-plus"></i> Schedule for Next Visit</h2>
                    <button class="btn btn-secondary" onclick="showScheduledTasks()">
                        <i class="bi bi-arrow-left"></i> Back to Schedule
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="bi bi-geo-alt"></i> Add tasks to do on next visit to this site:</h5>
                            </div>
                            <div class="card-body">
                                <form id="nextVisitForm">
                                    <div class="mb-3">
                                        <label for="nextVisitSite" class="form-label">Select Site *</label>
                                        <select class="form-select" id="nextVisitSite" required onchange="loadNextVisitTasks()">
                                            <option value="">Choose site...</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Tasks to Schedule for Next Visit *</label>
                                        <div class="mb-2">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="filterNextVisitTasks('common')">
                                                <i class="bi bi-star"></i> Common Tasks
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="filterNextVisitTasks('all')">
                                                <i class="bi bi-list"></i> All Tasks
                                            </button>
                                        </div>
                                        <div id="nextVisitTaskCheckboxes"></div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="nextVisitDate" class="form-label">Planned Visit Date *</label>
                                            <input type="date" class="form-control" id="nextVisitDate" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="nextVisitTime" class="form-label">Planned Visit Time (Optional)</label>
                                            <input type="time" class="form-control" id="nextVisitTime">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="nextVisitPriority" class="form-label">Priority</label>
                                        <select class="form-select" id="nextVisitPriority">
                                            <option value="normal">Normal</option>
                                            <option value="high">High</option>
                                            <option value="urgent">Urgent</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="nextVisitNotes" class="form-label">Notes for Next Visit</label>
                                        <textarea class="form-control" id="nextVisitNotes" rows="3" placeholder="Any specific instructions or notes for the next visit..."></textarea>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-success">
                                            <i class="bi bi-calendar-plus"></i> Schedule Tasks for Next Visit
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="showScheduledTasks()">
                                            <i class="bi bi-x"></i> Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Suggested Schedule View -->
            <div id="suggestedScheduleView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-lightbulb"></i> Suggested Schedule</h2>
                    <button class="btn btn-secondary" onclick="showScheduledTasks()">
                        <i class="bi bi-arrow-left"></i> Back to Schedule
                    </button>
                </div>
                <div id="integrityTOC" class="mb-3"></div>
                
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-calendar-heart"></i> Seasonal Task Suggestions</h5>
                    </div>
                    <div class="card-body">
                        <div id="suggestedTasksList">
                            <p class="text-muted">Loading suggestions...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Task Management View -->
            <div id="tasksView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-list-task"></i> Task Management</h2>
                    <button class="btn btn-primary" onclick="showAddTaskForm()">
                        <i class="bi bi-plus-circle"></i> Add New Task
                    </button>
                </div>
                
                <!-- Task Display Options -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-gear"></i> Task Display Options</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="taskGroupingToggle" checked>
                                            <label class="form-check-label" for="taskGroupingToggle">
                                                <strong>Group by Category</strong>
                                                <small class="text-muted d-block">Show tasks organized by category</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="taskAlphabeticalToggle">
                                            <label class="form-check-label" for="taskAlphabeticalToggle">
                                                <strong>Alphabetical List</strong>
                                                <small class="text-muted d-block">Show all tasks in alphabetical order</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Honey Type Management (Admin Only) -->
                <div class="row mb-4" id="honeyTypeManagement" style="display: none;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-flower1"></i> Honey Type Management</h5>
                                <small class="text-muted">Manage honey types for site selection</small>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Add New Honey Type</h6>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="newHoneyType" placeholder="Enter honey type name">
                                            <button class="btn btn-success" onclick="addHoneyType()">
                                                <i class="bi bi-plus"></i> Add
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Existing Honey Types</h6>
                                        <div id="honeyTypesList" class="list-group" style="max-height: 200px; overflow-y: auto;">
                                            <!-- Honey types will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Task List -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Available Tasks</h5>
                            </div>
                            <div class="card-body">
                                <div id="tasksList">
                                    <p class="text-center text-muted my-5">Loading tasks...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Flagged Items View -->
            <div id="flaggedView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-flag"></i> Flagged Items</h2>
                </div>
                
                
                <div id="flaggedItemsList2">
                    <p class="text-center text-muted my-5">Loading flagged items...</p>
                </div>
            </div>

            <!-- Employee Management View -->
            <div id="employeesView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-people"></i> Team Management</h2>
                </div>
                
                
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="bi bi-person-plus"></i> Add Employee</h5>
                            </div>
                            <div class="card-body">
                                <form id="addEmployeeForm">
                                    <div class="mb-3">
                                        <label for="newEmployeeName" class="form-label">Employee Name</label>
                                        <input type="text" class="form-control" id="newEmployeeName" autocomplete="username" required>
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i> A secure password will be generated automatically. 
                                            You can generate a new password anytime in the "Current Team" section.
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-plus"></i> Add Employee
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="bi bi-people-fill"></i> Current Team</h5>
                            </div>
                            <div class="card-body">
                                <div id="employeesList">
                                    <p class="text-muted">Loading employees...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compliance Management View -->
            <div id="complianceView" class="hidden">
                <div id="complianceQuickLinks" class="mb-2"></div>
                <div id="complianceDashboard">
                    <!-- Compliance content will be rendered here -->
                </div>
            </div>

            <!-- Data Integrity Check View -->
            <div id="integrityCheckView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-clipboard-data"></i> Data Integrity Check</h2>
                    <button class="btn btn-primary" onclick="runIntegrityCheck()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Check
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-shield-check"></i> Data Integrity Analysis
                        </h5>
                        <small class="text-muted">Identify data inconsistencies and missing information across sites</small>
                    </div>
                    <div class="card-body">
                <div id="integrityTOCInCard" class="mb-3"></div>
                        <div id="integrityCheckSection">
                            <div class="d-flex align-items-center justify-content-center" style="min-height: 200px;">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-3 text-muted">Analyzing data integrity...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Schedule Task Modal -->
        <div class="modal fade" id="scheduleTaskModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Schedule New Task</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="scheduleTaskForm">
                            <div class="mb-3">
                                <label for="scheduleSite" class="form-label">Site *</label>
                                <select class="form-select" id="scheduleSite" required>
                                    <option value="">Select site...</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="scheduleTask" class="form-label">Task *</label>
                                <select class="form-select" id="scheduleTask" required>
                                    <option value="">Select task...</option>
                                </select>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="scheduleDueDate" class="form-label">Due Date *</label>
                                    <input type="date" class="form-control" id="scheduleDueDate" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="scheduleTime" class="form-label">Time (Optional)</label>
                                    <input type="time" class="form-control" id="scheduleTime">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="schedulePriority" class="form-label">Priority</label>
                                <select class="form-select" id="schedulePriority">
                                    <option value="normal">Normal</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="scheduleNotes" class="form-label">Notes</label>
                                <textarea class="form-control" id="scheduleNotes" rows="3"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="handleScheduleTask(event)">Schedule Task</button>
                    </div>
                </div>
            </div>
        </div>

    <!-- Edit Scheduled Task Modal -->
    <div class="modal fade" id="editScheduledTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Scheduled Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                                    <div class="modal-body">
                    <form id="editScheduledTaskForm">
                        <input type="hidden" id="editTaskId">
                        <div class="mb-3">
                            <label for="editTaskSite" class="form-label">Site *</label>
                            <select class="form-select" id="editTaskSite" required>
                                <option value="">Select site...</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editTaskType" class="form-label">Task *</label>
                            <select class="form-select" id="editTaskType" required>
                                <option value="">Select task...</option>
                            </select>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editTaskDate" class="form-label">Due Date *</label>
                                <input type="date" class="form-control" id="editTaskDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editTaskTime" class="form-label">Time (Optional)</label>
                                <input type="time" class="form-control" id="editTaskTime">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editTaskPriority" class="form-label">Priority</label>
                            <select class="form-select" id="editTaskPriority">
                                <option value="normal">Normal</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editTaskNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="editTaskNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="handleEditScheduledTask()">Update Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Popup Modal -->
    <div class="modal fade" id="welcomeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: var(--glass); backdrop-filter: blur(12px) saturate(1.1); border: 1px solid rgba(255,255,255,0.2);">
                <div class="modal-header border-0">
                    <h5 class="modal-title d-flex align-items-center">
                        <i class="bi bi-hexagon-fill me-2" style="color: var(--accent); font-size: 1.5rem;"></i>
                        Welcome to BeeMarshall
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-4">
                        <i class="bi bi-check-circle-fill text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <h4 class="mb-3" id="welcomeUserName">Dashboard Loaded Successfully!</h4>
                    <p class="text-muted mb-4" id="welcomeMessage">
                        Your apiary management system is ready. All data has been synchronized and the dashboard is fully operational.
                    </p>
                    
                    <!-- Data Sync Status -->
                    <div class="alert alert-success border-0" style="background: rgba(40, 167, 69, 0.1);">
                        <div class="d-flex flex-column align-items-center justify-content-center">
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                <span class="fw-semibold">Data synchronised</span>
                            </div>
                            <small class="text-muted" id="syncTimestamp">Last updated: <span id="syncTime"></span></small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-success hexagon-button" data-bs-dismiss="modal" onclick="dismissWelcomeModal()">
                        <div class="hexagon-content">
                            <span class="hexagon-text">continue</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Scripts -->
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- BeeMarshall Modules v1.3 -->
    <!-- Environment Management -->
    <script src="js/utils.js"></script>
    <!-- Form Validation System -->
    <script src="js/form-validation.js"></script>
    <!-- BeeMarshall JavaScript Modules -->
    <!-- Environment Variables (injected at build time) -->
    <script src="js/env-config.js"></script>
    <!-- bcrypt for secure password hashing -->
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
    <!-- Secure Configuration (must load first) -->
    <script src="js/config.js"></script>
    <script src="js/permissions.js"></script>
    <script src="js/scheduling.js"></script>
    <script src="js/compliance.js"></script>
    <script src="js/calendar-feed.js"></script>
    <script src="js/sites.js"></script>
    <script src="js/actions.js"></script>
    <script src="js/employees.js"></script>

    <script src="js/navigation.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/sync-status.js"></script>
    <script src="js/core.js"></script>
    <script src="js/tasks.js"></script>
    
    <!-- Immediate test to verify JavaScript loading -->
    <script>
        console.log('🧪 HTML script test - JavaScript is working');
        window.htmlTestFunction = function() {
            console.log('✅ HTML test function called successfully');
            alert('JavaScript is working! Test buttons should be functional.');
        };
    </script>
    
    
    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration - Loaded from secure environment variables
        const firebaseConfig = {
            apiKey: window.ENV_FIREBASE_API_KEY || "demo-api-key",
            authDomain: window.ENV_FIREBASE_AUTH_DOMAIN || "demo-project.firebaseapp.com",
            databaseURL: window.ENV_FIREBASE_DATABASE_URL || "https://demo-project-default-rtdb.firebaseio.com",
            projectId: window.ENV_FIREBASE_PROJECT_ID || "demo-project",
            storageBucket: window.ENV_FIREBASE_STORAGE_BUCKET || "demo-project.appspot.com",
            messagingSenderId: window.ENV_FIREBASE_MESSAGING_SENDER_ID || "123456789",
            appId: window.ENV_FIREBASE_APP_ID || "1:123456789:web:abcdef123456",
            measurementId: "G-4WMTWPWWFD"
        };
        
        // Initialize Firebase only if we have valid configuration
        if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_FIREBASE_API_KEY") {
            try {
                firebase.initializeApp(firebaseConfig);
                window.database = firebase.database();
                console.log('✅ Firebase initialized successfully');
            } catch (error) {
                console.warn('⚠️ Firebase initialization failed:', error.message);
                window.database = null;
            }
        } else {
            console.warn('⚠️ Firebase configuration not available - running in offline mode');
            window.database = null;
        }
        
        // Map activation function
        function activateMap() {
            console.log('🗺️ Activating map...');
            
            // Hide placeholder and show map
            document.getElementById('mapPlaceholder').style.display = 'none';
            document.getElementById('map').style.display = 'block';
            
            // Check if map is already initialized
            if (window.beeMarshallMap) {
                console.log('🗺️ Map already initialized, refreshing markers...');
                // Clear existing markers
                if (window.beeMarshallMarkers) {
                    window.beeMarshallMarkers.forEach(marker => marker.remove());
                    window.beeMarshallMarkers = [];
                }
                // Re-render sites
                renderSitesOnMap();
                return;
            }
            
            // Initialize Leaflet map
            if (typeof L !== 'undefined') {
                window.beeMarshallMap = L.map('map', {
                    center: [-40.6781, 172.6886], // Collingwood, NZ
                    zoom: 13,
                    zoomControl: true,
                    attributionControl: true
                });
                
                // Add OpenStreetMap tiles with better loading
                const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19,
                    tileSize: 256,
                    zoomOffset: 0
                }).addTo(window.beeMarshallMap);
                
                console.log('🗺️ Map initialized successfully');
                
                // Wait for map to be ready
                window.beeMarshallMap.whenReady(() => {
                    console.log('🗺️ Map container ready, waiting for tiles...');
                    
                    // Wait for tiles to load completely
                    tileLayer.on('load', () => {
                        console.log('🗺️ Map tiles fully loaded, adding site markers...');
                        // Small delay to ensure tiles are rendered
                        setTimeout(() => {
                            renderSitesOnMap();
                        }, 500);
                    });
                    
                    // Fallback timeout in case tiles don't load
                    setTimeout(() => {
                        console.log('🗺️ Fallback: Adding markers after timeout...');
                        renderSitesOnMap();
                    }, 3000);
                });
                
                console.log('✅ Map activated successfully');
            } else {
                console.error('❌ Leaflet library not loaded');
            }
        }
        
        // Function to render sites on map with proper marker management
        function renderSitesOnMap() {
            if (!window.beeMarshallMap) {
                console.log('🗺️ Map not initialized, skipping marker rendering');
                return;
            }
            
            // Clear existing markers
            if (window.beeMarshallMarkers) {
                window.beeMarshallMarkers.forEach(marker => marker.remove());
                window.beeMarshallMarkers = [];
            }
            
            // Initialize markers array
            window.beeMarshallMarkers = [];
            
            // Add site markers
            if (typeof sites !== 'undefined' && sites.length > 0) {
                console.log(`📍 Rendering ${sites.length} site markers...`);
                
                sites.forEach(site => {
                    // Use latitude/longitude instead of lat/lng
                    const lat = site.latitude || site.lat;
                    const lng = site.longitude || site.lng;
                    
                    if (lat && lng) {
                        // Get site type info for color-coding
                        const SITE_TYPES = {
                            'production': { name: 'Production', color: '#28a745', icon: 'bi-briefcase' },
                            'nucleus': { name: 'NUC', color: '#ffc107', icon: 'bi-layer-forward' },
                            'breeding': { name: 'Breeding', color: '#dc3545', icon: 'bi-heart' },
                            'research': { name: 'Research', color: '#17a2b8', icon: 'bi-flask' },
                            'custom': { name: 'Custom', color: '#6c757d', icon: 'bi-geo-alt' }
                        };
                        
                        const typeInfo = SITE_TYPES[site.functionalClassification] || SITE_TYPES['custom'];
                        
                        // Get pending tasks for this site
                        const siteTasks = (typeof scheduledTasks !== 'undefined' && scheduledTasks) 
                            ? scheduledTasks.filter(task => task.siteId === site.id && !task.completed)
                                                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
                            : [];
                        
                        // Create custom icon with site type color
                        const customIcon = L.divIcon({
                            className: 'custom-site-marker',
                            html: `<div style="
                                background-color: ${typeInfo.color};
                                width: 24px;
                                height: 24px;
                                border-radius: 50%;
                                border: 2px solid white;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 12px;
                            "><i class="bi ${typeInfo.icon}"></i></div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        });
                        
                        const marker = L.marker([lat, lng], { icon: customIcon })
                            .addTo(window.beeMarshallMap)
                            .bindPopup(`
                                <div style="padding:10px; min-width:250px;">
                                    <h6>
                                        <a href="#" onclick="showSites(); return false;" style="color: ${typeInfo.color}; text-decoration: none; font-weight: bold; cursor: pointer;">
                                            <i class="bi ${typeInfo.icon}"></i> ${site.name}
                                        </a>
                                    </h6>
                                    <p class="mb-1"><small>${site.description || 'No description'}</small></p>
                                    <p class="mb-1"><strong>Type:</strong> <span style="color: ${typeInfo.color};">${typeInfo.name}</span></p>
                                    <p class="mb-1"><strong>Hives:</strong> ${site.hiveCount || 0}</p>
                                    ${site.harvestTimeline ? `<p class="mb-1"><strong>Harvest:</strong> ${site.harvestTimeline}</p>` : ''}
                                    ${site.sugarRequirements ? `<p class="mb-1"><strong>Sugar:</strong> ${site.sugarRequirements}</p>` : ''}
                                    ${site.landownerName ? `<p class="mb-1"><strong>Landowner:</strong> ${site.landownerName}</p>` : ''}
                                    
                                    ${siteTasks.length > 0 ? `
                                        <div class="mt-3">
                                            <h6 class="mb-2"><i class="bi bi-list-check"></i> Pending Tasks (${siteTasks.length})</h6>
                                            <div class="pending-tasks-list" style="max-height: 150px; overflow-y: auto;">
                                                ${siteTasks.slice(0, 5).map(task => {
                                                    const dueDate = new Date(task.dueDate);
                                                    const isOverdue = dueDate < new Date();
                                                    const priorityClass = task.priority === 'urgent' ? 'danger' : task.priority === 'high' ? 'warning' : 'secondary';
                                                    
                                                    return `
                                                        <div class="pending-task-item mb-2 p-2" style="border-left: 3px solid var(--${priorityClass}); background: rgba(0,0,0,0.05); border-radius: 3px;">
                                                            <div class="d-flex justify-content-between align-items-start">
                                                                <div class="flex-grow-1">
                                                                    <strong style="font-size: 0.85rem;">${task.taskName || 'Task'}</strong>
                                                                    <br><small class="text-muted">Due: ${dueDate.toLocaleDateString()}</small>
                                                                    ${isOverdue ? '<br><span class="badge bg-danger" style="font-size: 0.7rem;">OVERDUE</span>' : ''}
                                                                    ${task.priority !== 'normal' ? `<br><span class="badge bg-${priorityClass}" style="font-size: 0.7rem;">${task.priority.toUpperCase()}</span>` : ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                                ${siteTasks.length > 5 ? `<small class="text-muted">... and ${siteTasks.length - 5} more tasks</small>` : ''}
                                            </div>
                                        </div>
                                    ` : `
                                        <div class="mt-3">
                                            <p class="text-muted mb-0"><i class="bi bi-check-circle"></i> No pending tasks</p>
                                        </div>
                                    `}
                                    
                                    <div class="mt-3 d-grid gap-1">
                                        <button class="btn btn-sm btn-primary" onclick="showSites(); return false;">
                                            <i class="bi bi-eye"></i> View Details
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="if(typeof openInMaps === 'function') { openInMaps(${site.id}); } return false;">
                                            <i class="bi bi-geo-alt-fill"></i> View on Maps
                                        </button>
                                        <button class="btn btn-sm btn-success" onclick="if(typeof scheduleTaskForSite === 'function') { scheduleTaskForSite(${site.id}); } return false;">
                                            <i class="bi bi-calendar-plus"></i> Schedule Task
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning" onclick="if(typeof editSite === 'function') { editSite(${site.id}); } return false;">
                                            <i class="bi bi-pencil"></i> Edit Site
                                        </button>
                                        ${siteTasks.length > 0 ? `
                                            <button class="btn btn-sm btn-outline-info" onclick="if(typeof showScheduledTasks === 'function') { showScheduledTasks(); } return false;">
                                                <i class="bi bi-list-check"></i> View All Tasks
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `, {
                                maxWidth: 300,
                                className: 'site-popup'
                            });
                        
                        window.beeMarshallMarkers.push(marker);
                        console.log(`✅ Added marker for ${site.name} at [${lat}, ${lng}]`);
                    } else {
                        console.log(`⚠️ Site ${site.name} missing coordinates: lat=${site.latitude}, lng=${site.longitude}`);
                    }
                });
                
                console.log(`📍 Added ${window.beeMarshallMarkers.length} site markers`);
            } else {
                console.log('📍 No sites to render on map');
            }
        }
        
        // Hive strength breakdown functions
        function updateHiveStrengthTotals() {
            const totalHives = parseInt(document.getElementById('siteHiveCount').value) || 0;
            const strong = parseInt(document.getElementById('hiveStrong').value) || 0;
            const medium = parseInt(document.getElementById('hiveMedium').value) || 0;
            const weak = parseInt(document.getElementById('hiveWeak').value) || 0;
            const nuc = parseInt(document.getElementById('hiveNUC').value) || 0;
            const dead = parseInt(document.getElementById('hiveDead').value) || 0;
            
            const breakdownTotal = strong + medium + weak + nuc + dead;
            const totalElement = document.getElementById('hiveStrengthTotal');
            const statusElement = document.getElementById('hiveStrengthStatus');
            
            if (totalElement) {
                totalElement.textContent = breakdownTotal;
            }
            
            if (statusElement) {
                if (breakdownTotal === 0) {
                    statusElement.textContent = 'Enter hive counts above';
                    statusElement.className = 'text-muted';
                } else if (breakdownTotal === totalHives) {
                    statusElement.textContent = '✅ Breakdown matches total hive count';
                    statusElement.className = 'text-success';
                } else if (breakdownTotal < totalHives) {
                    statusElement.textContent = `⚠️ Breakdown (${breakdownTotal}) is less than total (${totalHives})`;
                    statusElement.className = 'text-warning';
                } else {
                    statusElement.textContent = `❌ Breakdown (${breakdownTotal}) exceeds total (${totalHives})`;
                    statusElement.className = 'text-danger';
                }
            }
            
            // Update detailed breakdown summary
            updateDetailedBreakdown(strong, medium, weak, nuc, dead, totalHives);
        }
        
        function updateDetailedBreakdown(strong, medium, weak, nuc, dead, totalHives) {
            const hiveStateCard = document.getElementById('hiveStateCard');
            
            // Show hive state card if there are any hives
            if (strong + medium + weak + nuc + dead > 0) {
                hiveStateCard.style.display = 'block';
                
                // Update color-coded numbers
                document.getElementById('hiveStateStrong').textContent = strong;
                document.getElementById('hiveStateMedium').textContent = medium;
                document.getElementById('hiveStateWeak').textContent = weak;
                document.getElementById('hiveStateNUC').textContent = nuc;
                document.getElementById('hiveStateDead').textContent = dead;
            } else {
                hiveStateCard.style.display = 'none';
            }
            
            // Note: Stack configuration summary is handled by the visual hive grid
        }
        
        // Auto-distribute hives when total count changes
        function autoDistributeHives() {
            const totalHives = parseInt(document.getElementById('siteHiveCount').value) || 0;
            if (totalHives > 0) {
                // Suggest a proportional distribution
                const strong = Math.round(totalHives * 0.4); // 40% strong
                const medium = Math.round(totalHives * 0.3); // 30% medium
                const weak = Math.round(totalHives * 0.2); // 20% weak
                const nuc = Math.round(totalHives * 0.05); // 5% NUC
                const dead = Math.round(totalHives * 0.05); // 5% dead
                
                document.getElementById('hiveStrong').value = strong;
                document.getElementById('hiveMedium').value = medium;
                document.getElementById('hiveWeak').value = weak;
                document.getElementById('hiveNUC').value = nuc;
                document.getElementById('hiveDead').value = dead;
                
                updateHiveStrengthTotals();
            }
        }
        
        // Stack configuration functions
        function updateStackTotals() {
            const doubles = parseInt(document.getElementById('stackDoubles').value) || 0;
            const topSplits = parseInt(document.getElementById('stackTopSplits').value) || 0;
            const singles = parseInt(document.getElementById('stackSingles').value) || 0;
            const nucs = parseInt(document.getElementById('stackNUCs').value) || 0;
            const empty = parseInt(document.getElementById('stackEmpty').value) || 0;
            
            const stackTotal = doubles + topSplits + singles + nucs + empty;
            const totalElement = document.getElementById('stackTotal');
            const statusElement = document.getElementById('stackStatus');
            
            if (totalElement) {
                totalElement.textContent = stackTotal;
            }
            
            if (statusElement) {
                if (stackTotal === 0) {
                    statusElement.textContent = 'Enter stack counts above';
                    statusElement.className = 'text-muted';
                } else {
                    statusElement.textContent = `📊 Stack breakdown: ${doubles} doubles, ${topSplits} top-splits, ${singles} singles, ${nucs} NUCs, ${empty} empty`;
                    statusElement.className = 'text-info';
                }
            }
        }
        
        function updateStackBreakdownSummary() {
            // This function is no longer needed - visual hive grid replaces it
            // Removed to prevent errors with non-existent DOM elements
        }
        
        // Auto-distribute stacks when total count changes
        function autoDistributeStacks() {
            const totalHives = parseInt(document.getElementById('siteHiveCount').value) || 0;
            if (totalHives > 0) {
                // Suggest a proportional stack distribution
                const doubles = Math.round(totalHives * 0.3); // 30% doubles
                const topSplits = Math.round(totalHives * 0.2); // 20% top-splits
                const singles = Math.round(totalHives * 0.4); // 40% singles
                const nucs = Math.round(totalHives * 0.05); // 5% NUCs
                const empty = Math.round(totalHives * 0.05); // 5% empty
                
                document.getElementById('stackDoubles').value = doubles;
                document.getElementById('stackTopSplits').value = topSplits;
                document.getElementById('stackSingles').value = singles;
                document.getElementById('stackNUCs').value = nucs;
                document.getElementById('stackEmpty').value = empty;
                
                updateStackTotals();
            }
        }
        
        // CSV Export Functions
        function exportSitesCSV() {
            if (!window.sites || window.sites.length === 0) {
                beeMarshallAlert('No site data available to export.', 'info');
                return;
            }
            
            const csvData = window.sites.map(site => {
                return {
                    'Site ID': site.id,
                    'Name': site.name,
                    'Description': site.description || '',
                    'Latitude': site.latitude,
                    'Longitude': site.longitude,
                    'Total Hives': site.hiveCount,
                    'Strong Hives': site.hiveStrength?.strong || 0,
                    'Medium Hives': site.hiveStrength?.medium || 0,
                    'Weak Hives': site.hiveStrength?.weak || 0,
                    'NUC Hives': site.hiveStrength?.nuc || 0,
                    'Dead Hives': site.hiveStrength?.dead || 0,
                    'Double Stacks': site.hiveStacks?.doubles || 0,
                    'Top-Splits': site.hiveStacks?.topSplits || 0,
                    'Single Stacks': site.hiveStacks?.singles || 0,
                    'NUC Stacks': site.hiveStacks?.nucs || 0,
                    'Empty Platforms': site.hiveStacks?.empty || 0,
                    'Functional Classification': site.functionalClassification || site.siteType || '',
                    'Seasonal Classification': site.seasonalClassification || site.seasonal_classification || '',
                    'Landowner Name': site.landownerName || '',
                    'Landowner Phone': site.landownerPhone || '',
                    'Landowner Email': site.landownerEmail || '',
                    'Landowner Address': site.landownerAddress || '',
                    'Access Type': site.accessType || '',
                    'Contact Before Visit': site.contactBeforeVisit ? 'Yes' : 'No',
                    'Quarantine': site.isQuarantine ? 'Yes' : 'No',
                    'Harvest Timeline': site.harvestTimeline || '',
                    'Sugar Requirements': site.sugarRequirements || '',
                    'Notes': site.notes || '',
                    'Created At': site.createdAt || '',
                    'Last Modified By': site.lastModifiedBy || '',
                    'Last Modified At': site.lastModifiedAt || ''
                };
            });
            
            downloadCSV(csvData, `sites_export_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function exportActionsCSV() {
            if (!window.actions || window.actions.length === 0) {
                beeMarshallAlert('No action data available to export.', 'info');
                return;
            }
            
            const csvData = window.actions.map(action => {
                // Find site name from ID
                const site = window.sites.find(s => s.id === action.siteId);
                const siteName = site ? site.name : '';
                
                return {
                    'Action ID': action.id,
                    'Date': action.date || '',
                    'Site ID': action.siteId || '',
                    'Site Name': siteName,
                    'Task ID': action.taskId || '',
                    'Task Name': action.taskName || '',
                    'Task Category': action.taskCategory || '',
                    'Individual Hive ID': action.individualHiveId || '',
                    'Notes': action.notes || '',
                    'Flag': action.flag || '',
                    'Logged By': action.loggedBy || '',
                    'Created At': action.createdAt || '',
                    'From Scheduled Task': action.fromScheduledTask ? 'Yes' : 'No',
                    'Original Scheduled Task ID': action.originalScheduledTaskId || ''
                };
            });
            
            downloadCSV(csvData, `actions_export_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function exportScheduledTasksCSV() {
            if (!window.scheduledTasks || window.scheduledTasks.length === 0) {
                beeMarshallAlert('No scheduled task data available to export.', 'info');
                return;
            }
            
            const csvData = window.scheduledTasks.map(task => {
                // Find site name from ID
                const site = window.sites.find(s => s.id === task.siteId);
                const siteName = site ? site.name : '';
                
                // Find task name from task ID
                const taskObj = window.tasks.find(t => t.id === task.taskId);
                const taskName = taskObj ? taskObj.name : '';
                const taskCategory = taskObj ? taskObj.category : '';
                
                return {
                    'Task ID': task.id,
                    'Task Type ID': task.taskId || '',
                    'Task Name': taskName,
                    'Task Category': taskCategory,
                    'Site ID': task.siteId || '',
                    'Site Name': siteName,
                    'Individual Hive ID': task.individualHiveId || '',
                    'Due Date': task.dueDate || '',
                    'Scheduled Time': task.scheduledTime || '',
                    'Priority': task.priority || '',
                    'Status': task.completed ? 'Completed' : 'Pending',
                    'Notes': task.notes || '',
                    'Overdue': task.overdue ? 'Yes' : 'No',
                    'Overdue Date': task.overdueDate || '',
                    'Created By': task.createdBy || '',
                    'Created At': task.createdAt || '',
                    'Completed By': task.completedBy || '',
                    'Completed At': task.completedAt || '',
                    'Last Modified By': task.lastModifiedBy || '',
                    'Last Modified At': task.lastModifiedAt || ''
                };
            });
            
            downloadCSV(csvData, `scheduled_tasks_export_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function exportIndividualHivesCSV() {
            if (!window.individualHives || window.individualHives.length === 0) {
                beeMarshallAlert('No individual hive data available to export.', 'info');
                return;
            }
            
            const csvData = window.individualHives.map(hive => {
                // Find site name from ID
                const site = window.sites.find(s => s.id === hive.siteId);
                const siteName = site ? site.name : '';
                
                return {
                    'Hive ID': hive.id,
                    'Site ID': hive.siteId || '',
                    'Site Name': siteName,
                    'Hive Name': hive.hiveName || '',
                    'Hive Number': hive.hiveNumber || '',
                    'Status': hive.status || '',
                    'Queen Status': hive.queenStatus || '',
                    'Brood Pattern': hive.broodPattern || '',
                    'Food Stores': hive.foodStores || '',
                    'Population': hive.population || '',
                    'Notes': hive.notes || '',
                    'Created At': hive.createdAt || '',
                    'Last Modified At': hive.lastModifiedAt || ''
                };
            });
            
            downloadCSV(csvData, `individual_hives_export_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function exportAllDataCSV() {
            const allData = [];
            
            // Add sites data
            if (window.sites && window.sites.length > 0) {
                window.sites.forEach(site => {
                    allData.push({
                        'Data Type': 'Site',
                        'ID': site.id,
                        'Name': site.name,
                        'Description': site.description || '',
                        'Latitude': site.latitude,
                        'Longitude': site.longitude,
                        'Total Hives': site.hiveCount,
                        'Strong Hives': site.hiveStrength?.strong || 0,
                        'Medium Hives': site.hiveStrength?.medium || 0,
                        'Weak Hives': site.hiveStrength?.weak || 0,
                        'NUC Hives': site.hiveStrength?.nuc || 0,
                        'Dead Hives': site.hiveStrength?.dead || 0,
                        'Double Stacks': site.hiveStacks?.doubles || 0,
                        'Top-Splits': site.hiveStacks?.topSplits || 0,
                        'Single Stacks': site.hiveStacks?.singles || 0,
                        'NUC Stacks': site.hiveStacks?.nucs || 0,
                        'Empty Platforms': site.hiveStacks?.empty || 0,
                        'Functional Classification': site.functionalClassification || site.siteType || '',
                        'Seasonal Classification': site.seasonalClassification || site.seasonal_classification || '',
                        'Landowner Name': site.landownerName || '',
                        'Landowner Phone': site.landownerPhone || '',
                        'Landowner Email': site.landownerEmail || '',
                        'Landowner Address': site.landownerAddress || '',
                        'Access Type': site.accessType || '',
                        'Contact Before Visit': site.contactBeforeVisit ? 'Yes' : 'No',
                        'Quarantine': site.isQuarantine ? 'Yes' : 'No',
                        'Harvest Timeline': site.harvestTimeline || '',
                        'Sugar Requirements': site.sugarRequirements || '',
                        'Notes': site.notes || '',
                        'Created At': site.createdAt || '',
                        'Last Modified By': site.lastModifiedBy || '',
                        'Last Modified At': site.lastModifiedAt || ''
                    });
                });
            }
            
            // Add tasks data
            if (window.tasks && window.tasks.length > 0) {
                window.tasks.forEach(task => {
                    allData.push({
                        'Data Type': 'Task',
                        'ID': task.id,
                        'Name': task.name || '',
                        'Category': task.category || '',
                        'Description': task.description || '',
                        'Created At': task.createdAt || '',
                        'Last Modified At': task.lastModifiedAt || ''
                    });
                });
            }
            
            // Add deleted tasks archive (if any)
            if (window.deletedTasks && typeof window.deletedTasks === 'object' && Object.keys(window.deletedTasks).length > 0) {
                Object.keys(window.deletedTasks).forEach(id => {
                    const t = window.deletedTasks[id];
                    allData.push({
                        'Data Type': 'Deleted Task',
                        'ID': id,
                        'Name': t?.name || '',
                        'Category': t?.category || '',
                        'Description': t?.description || '',
                        'Deleted': 'Yes'
                    });
                });
            }
            
            // Add actions data
            if (window.actions && window.actions.length > 0) {
                window.actions.forEach(action => {
                    // Find site name from ID
                    const site = window.sites.find(s => s.id === action.siteId);
                    const siteName = site ? site.name : '';
                    
                    allData.push({
                        'Data Type': 'Action',
                        'ID': action.id,
                        'Name': siteName,
                        'Description': action.description || '',
                        'Action Type': action.actionType || '',
                        'Date': action.date || '',
                        'Time': action.time || '',
                        'Performed By': action.performedBy || '',
                        'Hive Count': action.hiveCount || '',
                        'Honey Harvested': action.honeyHarvested || '',
                        'Sugar Fed': action.sugarFed || '',
                        'Disease Found': action.diseaseFound || '',
                        'Disease Type': action.diseaseType || '',
                        'Treatment Applied': action.treatmentApplied || '',
                        'Weather': action.weather || '',
                        'Temperature': action.temperature || '',
                        'Notes': action.notes || '',
                        'Flag': action.flag || '',
                        'Created At': action.createdAt || '',
                        'Last Modified By': '',
                        'Last Modified At': ''
                    });
                });
            }
            
            // Add scheduled tasks data
            if (window.scheduledTasks && window.scheduledTasks.length > 0) {
                window.scheduledTasks.forEach(task => {
                    // Find site name from ID
                    const site = window.sites.find(s => s.id === task.siteId);
                    const siteName = site ? site.name : '';
                    
                    allData.push({
                        'Data Type': 'Scheduled Task',
                        'ID': task.id,
                        'Name': task.title || '',
                        'Description': task.description || '',
                        'Due Date': task.dueDate || '',
                        'Priority': task.priority || '',
                        'Site Name': siteName,
                        'Assigned To': task.assignedTo || '',
                        'Status': task.completed ? 'Completed' : 'Pending',
                        'Completed At': task.completedAt || '',
                        'Created At': task.createdAt || '',
                        'Last Modified By': '',
                        'Last Modified At': ''
                    });
                });
            }
            
            // Add individual hives data
            if (window.individualHives && window.individualHives.length > 0) {
                window.individualHives.forEach(hive => {
                    // Find site name from ID
                    const site = window.sites.find(s => s.id === hive.siteId);
                    const siteName = site ? site.name : '';
                    
                    allData.push({
                        'Data Type': 'Individual Hive',
                        'ID': hive.id,
                        'Name': hive.hiveName || '',
                        'Description': hive.notes || '',
                        'Site Name': siteName,
                        'Hive Number': hive.hiveNumber || '',
                        'Status': hive.status || '',
                        'Queen Status': hive.queenStatus || '',
                        'Brood Pattern': hive.broodPattern || '',
                        'Food Stores': hive.foodStores || '',
                        'Population': hive.population || '',
                        'Created At': hive.createdAt || '',
                        'Last Modified By': '',
                        'Last Modified At': hive.lastModifiedAt || ''
                    });
                });
            }

            // Add employees data (tenant-scoped)
            if (window.employees && Array.isArray(window.employees) && window.employees.length > 0) {
                window.employees.forEach(emp => {
                    allData.push({
                        'Data Type': 'Employee',
                        'Username': emp.username || '',
                        'Role': emp.role || '',
                        'Status': emp.active ? 'Active' : (emp.status || 'Inactive'),
                        'Created By': emp.createdBy || '',
                        'Tenant ID': emp.tenantId || (typeof currentTenantId !== 'undefined' ? currentTenantId : ''),
                        'Device Remembered': emp.deviceRemembered ? 'Yes' : 'No',
                        'Temporary Password Expiry': emp.temporaryPasswordExpiry || '',
                        'Created At': emp.createdAt || '',
                        'Last Modified At': emp.lastModifiedAt || ''
                    });
                });
            }
            
            if (allData.length === 0) {
                beeMarshallAlert('No data available to export.', 'info');
                return;
            }
            
            downloadCSV(allData, `beemarshall_complete_export_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function downloadCSV(data, filename) {
            if (!data || data.length === 0) {
                beeMarshallAlert('No data to export.', 'info');
                return;
            }
            
            // Convert data to CSV format
            const headers = Object.keys(data[0]);
            
            // Create CSV content with header information
            const exportInfo = [
                `BeeMarshall Data Export`,
                `Exported By: ${typeof currentUser !== 'undefined' && currentUser ? currentUser.username : 'Unknown'}`,
                `Export Date: ${new Date().toISOString()}`,
                `Tenant: ${typeof currentTenantId !== 'undefined' && currentTenantId ? currentTenantId : 'N/A'}`,
                `Total Records: ${data.length}`,
                `Sites: ${typeof sites !== 'undefined' && sites ? sites.length : 0}`,
                `Actions: ${typeof actions !== 'undefined' && actions ? actions.length : 0}`,
                `Scheduled Tasks: ${typeof scheduledTasks !== 'undefined' && scheduledTasks ? scheduledTasks.length : 0}`,
                `Individual Hives: ${typeof individualHives !== 'undefined' && individualHives ? individualHives.length : 0}`,
                `Tasks: ${typeof tasks !== 'undefined' && tasks ? tasks.length : 0}`,
                `Employees: ${typeof employees !== 'undefined' && Array.isArray(employees) ? employees.length : 0}`,
                ``, // Empty line before data
            ];
            
            const csvContent = [
                exportInfo.join('\n'),
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const value = row[header] || '';
                        // Escape commas and quotes in CSV
                        return `"${String(value).replace(/"/g, '""')}"`;
                    }).join(',')
                )
            ].join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`📊 CSV exported: ${filename} (${data.length} records)`);
            beeMarshallAlert(`CSV exported successfully!\n\nFile: ${filename}\nRecords: ${data.length}\nUser: ${currentUser ? currentUser.username : 'Unknown'}`, 'success');
        }
        
        
        // Data Integrity Check Functions
        function showIntegrityCheck() {
            hideAllViews();
            setTimeout(() => {
                const view = document.getElementById('integrityCheckView');
                if (view) {
                    view.classList.remove('hidden');
                    view.style.display = ''; // Restore display to override hideAllViews display:none
                }
                if (typeof updateActiveNav === 'function') {
                    updateActiveNav('Data Integrity');
                }
                runIntegrityCheck();
            }, 50); // Ensure hideAllViews completes first
        }

        function runIntegrityCheck() {
            console.log('🔍 Running data integrity check...');
            
            // Show loading state
            const section = document.getElementById('integrityCheckSection');
            section.innerHTML = `
                <div class="d-flex align-items-center justify-content-center" style="min-height: 200px;">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Analyzing data integrity...</p>
                    </div>
                </div>
            `;
            
            // Run the check after a short delay to show loading
            setTimeout(() => {
                generateDataIntegrityCheck();
            }, 500);
        }

        function generateDataIntegrityCheck(sitesData = window.sites) {
            console.log('🔍 generateDataIntegrityCheck called');
            console.log('🔍 sites data passed:', sitesData);
            console.log('🔍 global sites:', window.sites);
            console.log('🔍 integrityCheckSection element:', document.getElementById('integrityCheckSection'));
            
            if (!sitesData || sitesData.length === 0) {
                console.log('🔍 No sites found, showing no sites message');
                const section = document.getElementById('integrityCheckSection');
                if (section) {
                    section.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No sites found. Add sites to perform data integrity checks.
                        </div>
                    `;
                } else {
                    console.error('❌ integrityCheckSection element not found!');
                }
                return;
            }
            
            console.log('🔍 Running data integrity check on', sitesData.length, 'sites...');
            
            const issues = {
                hiveCountMismatches: [],
                missingLandownerInfo: [],
                missingAccessInfo: [],
                missingGPS: [],
                missingContactDetails: [],
                invalidPhoneNumbers: [],
                missingHoneyTypes: [],
                overdueCompliance: []
            };
            
            // Check each site for data integrity issues
            sitesData.forEach(site => {
                // Check 1: Hive count consistency
                if (site.hiveStrength && site.hiveStacks) {
                    const hiveStrengthTotal = (site.hiveStrength.strong || 0) + 
                                             (site.hiveStrength.medium || 0) + 
                                             (site.hiveStrength.weak || 0) + 
                                             (site.hiveStrength.nuc || 0) + 
                                             (site.hiveStrength.dead || 0);
                    
                    const hiveBoxTotal = (site.hiveStacks.doubles || 0) * 2 +
                                        (site.hiveStacks.topSplits || 0) +
                                        (site.hiveStacks.singles || 0) +
                                        (site.hiveStacks.nucs || 0) +
                                        (site.hiveStacks.empty || 0);
                    
                    if (hiveStrengthTotal !== hiveBoxTotal && site.hiveCount > 0) {
                        issues.hiveCountMismatches.push({
                            siteName: site.name,
                            siteId: site.id,
                            strengthTotal: hiveStrengthTotal,
                            boxTotal: hiveBoxTotal,
                            difference: Math.abs(hiveStrengthTotal - hiveBoxTotal)
                        });
                    }
                }
                
                // Check 2: Missing landowner information
                if (!site.landownerName || !site.landownerName.trim()) {
                    issues.missingLandownerInfo.push({
                        siteName: site.name,
                        siteId: site.id,
                        missingField: 'Landowner Name'
                    });
                }
                
                // Check 3: Missing access information
                if (!site.accessType || !site.accessType.trim()) {
                    issues.missingAccessInfo.push({
                        siteName: site.name,
                        siteId: site.id,
                        missingField: 'Access Type'
                    });
                }
                
                // Check 4: Missing GPS coordinates
                if (!site.latitude || !site.longitude || 
                    site.latitude === 0 || site.longitude === 0) {
                    issues.missingGPS.push({
                        siteName: site.name,
                        siteId: site.id
                    });
                }
                
                // Check 5: Missing contact details
                const hasPhone = site.landownerPhone && site.landownerPhone.trim();
                const hasEmail = site.landownerEmail && site.landownerEmail.trim();
                if (!hasPhone && !hasEmail) {
                    issues.missingContactDetails.push({
                        siteName: site.name,
                        siteId: site.id
                    });
                }
                
                // Check 6: Invalid phone numbers (must contain at least 7 digits)
                if (hasPhone) {
                    const digits = (site.landownerPhone || '').replace(/\D/g, '');
                    if (digits.length > 0 && digits.length < 7) {
                        issues.invalidPhoneNumbers.push({
                            siteName: site.name,
                            siteId: site.id,
                            phone: site.landownerPhone
                        });
                    }
                }
                
                // Check 7: Missing honey types
                if (!site.honeyPotentials || !Array.isArray(site.honeyPotentials) || site.honeyPotentials.length === 0) {
                    issues.missingHoneyTypes.push({
                        siteName: site.name,
                        siteId: site.id
                    });
                }
            });
            
            // Check 8: Overdue compliance requirements
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            
            // Check for overdue Annual Disease Return (due by 1 June)
            const adrDeadline = new Date(currentYear, 5, 1); // June 1st
            if (currentDate > adrDeadline) {
                issues.overdueCompliance.push({
                    requirement: 'Annual Disease Return (ADR)',
                    deadline: '1 June ' + currentYear,
                    status: 'Overdue',
                    description: 'Annual Disease Return was due by 1 June ' + currentYear
                });
            }
            
            // Check for overdue Colony Return (due by 1 June)
            const colonyReturnDeadline = new Date(currentYear, 5, 1); // June 1st
            if (currentDate > colonyReturnDeadline) {
                issues.overdueCompliance.push({
                    requirement: 'Colony Return',
                    deadline: '1 June ' + currentYear,
                    status: 'Overdue',
                    description: 'Colony Return was due by 1 June ' + currentYear
                });
            }
            
            // Check for overdue Certificate of Inspection (COI) window (1 Aug - 30 Nov)
            const coiStart = new Date(currentYear, 7, 1); // August 1st
            const coiEnd = new Date(currentYear, 10, 30); // November 30th
            if (currentDate > coiEnd) {
                issues.overdueCompliance.push({
                    requirement: 'Certificate of Inspection (COI)',
                    deadline: '30 November ' + currentYear,
                    status: 'Overdue',
                    description: 'COI window closed on 30 November ' + currentYear
                });
            } else if (currentDate >= coiStart && currentDate <= coiEnd) {
                issues.overdueCompliance.push({
                    requirement: 'Certificate of Inspection (COI)',
                    deadline: '30 November ' + currentYear,
                    status: 'Due Soon',
                    description: 'COI window is open until 30 November ' + currentYear
                });
            }
            
            // Check for overdue levies and payments (due 1 June)
            const levyDeadline = new Date(currentYear, 5, 1); // June 1st
            if (currentDate > levyDeadline) {
                issues.overdueCompliance.push({
                    requirement: 'Levy Payment',
                    deadline: '1 June ' + currentYear,
                    status: 'Overdue',
                    description: 'Annual levy payment was due by 1 June ' + currentYear
                });
            }
            
            // Calculate total issues
            const totalIssues = issues.hiveCountMismatches.length + 
                              issues.missingLandownerInfo.length + 
                              issues.missingAccessInfo.length + 
                              issues.missingGPS.length + 
                              issues.missingContactDetails.length +
                              issues.invalidPhoneNumbers.length +
                              issues.missingHoneyTypes.length +
                              issues.overdueCompliance.length;
            
            // Generate HTML report
            let html = '';
            
            if (totalIssues === 0) {
                html = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle-fill"></i> <strong>Data Integrity: Excellent!</strong>
                        <p class="mb-0 mt-2">All sites have complete and consistent data. No issues detected.</p>
                    </div>
                `;
            } else {
                html = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Data Integrity Issues Found: ${totalIssues}</strong>
                        <p class="mb-0 mt-2">The following data inconsistencies and missing information have been detected across your sites:</p>
                    </div>
                `;
                // Table of Contents (internal bookmarks)
                const tocItems = [];
                if (issues.hiveCountMismatches.length > 0) tocItems.push(`<li><a href="#integrity-hive-mismatch" class="link-warning text-decoration-none">Hive Count Mismatches (${issues.hiveCountMismatches.length})</a></li>`);
                if (issues.missingLandownerInfo.length > 0) tocItems.push(`<li><a href="#integrity-missing-landowner" class="link-warning text-decoration-none">Missing Landowner Information (${issues.missingLandownerInfo.length})</a></li>`);
                if (issues.missingAccessInfo.length > 0) tocItems.push(`<li><a href="#integrity-missing-access" class="link-warning text-decoration-none">Missing Access Information (${issues.missingAccessInfo.length})</a></li>`);
                if (issues.missingGPS.length > 0) tocItems.push(`<li><a href="#integrity-missing-gps" class="link-warning text-decoration-none">Missing GPS Coordinates (${issues.missingGPS.length})</a></li>`);
                if (issues.missingContactDetails.length > 0) tocItems.push(`<li><a href="#integrity-missing-contact" class="link-warning text-decoration-none">Missing Contact Details (${issues.missingContactDetails.length})</a></li>`);
                if (issues.invalidPhoneNumbers && issues.invalidPhoneNumbers.length > 0) tocItems.push(`<li><a href="#integrity-invalid-phone" class="link-warning text-decoration-none">Invalid Phone Numbers (${issues.invalidPhoneNumbers.length})</a></li>`);
                if (issues.missingHoneyTypes.length > 0) tocItems.push(`<li><a href="#integrity-missing-honey" class="link-warning text-decoration-none">Missing Honey Types (${issues.missingHoneyTypes.length})</a></li>`);
                if (issues.overdueCompliance.length > 0) tocItems.push(`<li><a href="#integrity-overdue-compliance" class="link-warning text-decoration-none">Overdue Compliance (${issues.overdueCompliance.length})</a></li>`);
                // Prefer injecting inside the Analysis card; fallback to legacy placeholder if present
                const tocEl = document.getElementById('integrityTOCInCard') || document.getElementById('integrityTOC');
                if (tocEl) {
                    if (tocItems.length > 0) {
                        tocEl.innerHTML = `
                            <div id="integrity-top"></div>
                            <div class="card mb-3 border-warning" style="position: sticky; top: 0; z-index: 5;">
                                <div class="card-header bg-warning text-dark">
                                    <i class="bi bi-list-ul"></i> Jump to Issue Category
                                </div>
                                <div class="card-body py-2">
                                    <ul class="mb-0" style="columns: 2; -webkit-columns: 2; -moz-columns: 2;">
                                        ${tocItems.join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                    } else {
                        // Alternative quicklinks menu (shown even when no categories render)
                        tocEl.innerHTML = `
                            <div id="integrity-top"></div>
                            <div class="card mb-3 border-light">
                                <div class="card-header bg-light">
                                    <i class="bi bi-list-ul"></i> Quick Links
                                </div>
                                <div class="card-body py-2">
                                    <div class="d-flex flex-wrap gap-2">
                                        ${[
                                            { id: 'integrity-hive-mismatch', label: 'Hive Count Mismatches', count: issues.hiveCountMismatches.length },
                                            { id: 'integrity-missing-landowner', label: 'Missing Landowner', count: issues.missingLandownerInfo.length },
                                            { id: 'integrity-missing-access', label: 'Missing Access', count: issues.missingAccessInfo.length },
                                            { id: 'integrity-missing-gps', label: 'Missing GPS', count: issues.missingGPS.length },
                                            { id: 'integrity-missing-contact', label: 'Missing Contact', count: issues.missingContactDetails.length },
                                            { id: 'integrity-invalid-phone', label: 'Invalid Phone', count: issues.invalidPhoneNumbers ? issues.invalidPhoneNumbers.length : 0 },
                                            { id: 'integrity-missing-honey', label: 'Missing Honey Types', count: issues.missingHoneyTypes.length },
                                            { id: 'integrity-overdue-compliance', label: 'Overdue Compliance', count: issues.overdueCompliance.length }
                                        ].map(item => {
                                            const disabled = item.count === 0;
                                            const cls = disabled ? 'btn btn-sm btn-outline-secondary disabled' : 'btn btn-sm btn-outline-warning';
                                            const title = disabled ? 'No issues in this category' : `View ${item.label}`;
                                            const href = disabled ? 'javascript:void(0);' : `#${item.id}`;
                                            return `<a href="${href}" class="${cls}" title="${title}">${item.label} (${item.count})</a>`;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    // Ensure visible and conditionally auto-hide on small screens only
                    const tocCard = tocEl.querySelector('.card');
                    if (tocCard) {
                        tocCard.style.display = '';
                        console.log('🧭 Integrity TOC rendered with', tocItems.length, 'items');
                        if (window.innerWidth <= 576) {
                            setTimeout(() => {
                                tocCard.style.display = 'none';
                            }, 4000); // auto-hide on phones
                        }
                    }
                }
                
                // Hive count mismatches
                if (issues.hiveCountMismatches.length > 0) {
                    html += `
                        <div id="integrity-hive-mismatch" class="card mb-3 border-danger">
                            <div class="card-header bg-danger text-white">
                                <i class="bi bi-exclamation-triangle"></i> Hive Count Mismatches (${issues.hiveCountMismatches.length})
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Sites where hive strength counts don't match hive box counts:</p>
                                <ul class="list-group">
                    `;
                    issues.hiveCountMismatches.forEach(issue => {
                        html += `
                            <li class="list-group-item">
                                <strong>${issue.siteName}</strong> (ID: ${issue.siteId})
                                <br>
                                <small class="text-danger">
                                    Strength Total: ${issue.strengthTotal} | Box Total: ${issue.boxTotal} | Difference: ${issue.difference}
                                </small>
                                <button class="btn btn-sm btn-primary float-end" onclick="editSite(${issue.siteId})">
                                    <i class="bi bi-arrow-right"></i> Fix
                                </button>
                            </li>
                        `;
                    });
                    html += `
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                // Missing landowner info
                if (issues.missingLandownerInfo.length > 0) {
                    html += `
                        <div id="integrity-missing-landowner" class="card mb-3 border-warning">
                            <div class="card-header bg-warning text-dark">
                                <i class="bi bi-person-x"></i> Missing Landowner Information (${issues.missingLandownerInfo.length})
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Sites missing landowner name:</p>
                                <ul class="list-group">
                    `;
                    issues.missingLandownerInfo.forEach(issue => {
                        html += `
                            <li class="list-group-item">
                                <strong>${issue.siteName}</strong> (ID: ${issue.siteId})
                                <button class="btn btn-sm btn-primary float-end" onclick="editSite(${issue.siteId})">
                                    <i class="bi bi-arrow-right"></i> Fix
                                </button>
                            </li>
                        `;
                    });
                    html += `
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                // Missing access info
                if (issues.missingAccessInfo.length > 0) {
                    html += `
                        <div id="integrity-missing-access" class="card mb-3 border-warning">
                            <div class="card-header bg-warning text-dark">
                                <i class="bi bi-signpost"></i> Missing Access Information (${issues.missingAccessInfo.length})
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Sites missing access type:</p>
                                <ul class="list-group">
                    `;
                    issues.missingAccessInfo.forEach(issue => {
                        html += `
                            <li class="list-group-item">
                                <strong>${issue.siteName}</strong> (ID: ${issue.siteId})
                                <button class="btn btn-sm btn-primary float-end" onclick="editSite(${issue.siteId})">
                                    <i class="bi bi-arrow-right"></i> Fix
                                </button>
                            </li>
                        `;
                    });
                    html += `
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                // Missing GPS
                if (issues.missingGPS.length > 0) {
                    html += `
                        <div id="integrity-missing-gps" class="card mb-3 border-danger">
                            <div class="card-header bg-danger text-white">
                                <i class="bi bi-geo-alt"></i> Missing GPS Coordinates (${issues.missingGPS.length})
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Sites without GPS coordinates:</p>
                                <ul class="list-group">
                    `;
                    issues.missingGPS.forEach(issue => {
                        html += `
                            <li class="list-group-item">
                                <strong>${issue.siteName}</strong> (ID: ${issue.siteId})
                                <button class="btn btn-sm btn-primary float-end" onclick="editSite(${issue.siteId})">
                                    <i class="bi bi-arrow-right"></i> Fix
                                </button>
                            </li>
                        `;
                    });
                    html += `
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                // Missing contact details
                if (issues.missingContactDetails.length > 0) {
                    html += `
                        <div id="integrity-missing-contact" class="card mb-3 border-info">
                            <div class="card-header bg-info text-white">
                                <i class="bi bi-telephone-x"></i> Missing Contact Details (${issues.missingContactDetails.length})
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Sites without phone or email contact:</p>
                                <ul class="list-group">
                    `;
                    issues.missingContactDetails.forEach(issue => {
                        html += `
                            <li class="list-group-item">
                                <strong>${issue.siteName}</strong> (ID: ${issue.siteId})
                                <button class="btn btn-sm btn-primary float-end" onclick="editSite(${issue.siteId})">
                                    <i class="bi bi-arrow-right"></i> Fix
                                </button>
                            </li>
                        `;
                    });
                    html += `
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                // Invalid phone numbers
                if (issues.invalidPhoneNumbers.length > 0) {
                    html += `
                        <div id="integrity-invalid-phone" class="card mb-3 border-info">
                            <div class="card-header bg-info text-white">
                                <i class="bi bi-telephone-inbound"></i> Invalid Phone Numbers (${issues.invalidPhoneNumbers.length})
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Sites with phone numbers containing fewer than 7 digits:</p>
                                <ul class="list-group">
                    `;
                    issues.invalidPhoneNumbers.forEach(issue => {
                        html += `
                            <li class="list-group-item">
                                <strong>${issue.siteName}</strong> (ID: ${issue.siteId})
                                <br><small class="text-muted">Phone: ${issue.phone || 'N/A'}</small>
                                <button class="btn btn-sm btn-primary float-end" onclick="editSite(${issue.siteId})">
                                    <i class="bi bi-arrow-right"></i> Fix
                                </button>
                            </li>
                        `;
                    });
                    html += `
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                // Missing honey types
                if (issues.missingHoneyTypes.length > 0) {
                    html += `
                        <div id="integrity-missing-honey" class="card mb-3 border-warning">
                            <div class="card-header bg-warning text-dark">
                                <i class="bi bi-flower1"></i> Missing Honey Types (${issues.missingHoneyTypes.length})
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Sites without honey type information:</p>
                                <ul class="list-group">
                    `;
                    issues.missingHoneyTypes.forEach(issue => {
                        html += `
                            <li class="list-group-item">
                                <strong>${issue.siteName}</strong> (ID: ${issue.siteId})
                                <button class="btn btn-sm btn-primary float-end" onclick="editSite(${issue.siteId})">
                                    <i class="bi bi-arrow-right"></i> Fix
                                </button>
                            </li>
                        `;
                    });
                    html += `
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                // Overdue compliance requirements
                if (issues.overdueCompliance.length > 0) {
                    html += `
                        <div id="integrity-overdue-compliance" class="card mb-3 border-danger">
                            <div class="card-header bg-danger text-white">
                                <i class="bi bi-exclamation-triangle"></i> Overdue Compliance Requirements (${issues.overdueCompliance.length})
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Regulatory compliance items requiring attention:</p>
                                <ul class="list-group">
                    `;
                    issues.overdueCompliance.forEach(issue => {
                        html += `
                            <li class="list-group-item">
                                <strong>${issue.requirement}</strong><br>
                                <small class="text-${issue.status === 'Overdue' ? 'danger' : 'warning'}">${issue.status} - ${issue.deadline}</small><br>
                                <small class="text-muted">${issue.description}</small>
                            </li>
                        `;
                    });
                    html += `
                                </ul>
                            </div>
                        </div>
                    `;
                }
            }
            
            document.getElementById('integrityCheckSection').innerHTML = html;
            console.log('✅ Data integrity check completed:', { totalIssues });
        }

        // Handle navigation from reports
        function handleReportsNavigation() {
            const navigateToSite = localStorage.getItem('navigateToSite');
            const scheduleTaskData = localStorage.getItem('scheduleTaskForSite');
            
            if (navigateToSite) {
                localStorage.removeItem('navigateToSite');
                // Navigate to sites view and highlight specific site
                showSites();
                setTimeout(() => {
                    const siteElement = document.querySelector(`[data-site-id="${navigateToSite}"]`);
                    if (siteElement) {
                        siteElement.scrollIntoView({ behavior: 'smooth' });
                        siteElement.style.border = '2px solid var(--accent)';
                        siteElement.style.boxShadow = '0 0 20px rgba(255, 193, 7, 0.5)';
                        
                        // Automatically open edit form for the site
                        setTimeout(() => {
                            editSite(navigateToSite);
                        }, 500);
                    }
                }, 1000);
            }
            
            if (scheduleTaskData) {
                const data = JSON.parse(scheduleTaskData);
                localStorage.removeItem('scheduleTaskForSite');
                // Navigate to scheduled tasks and pre-fill form
                showScheduledTasks();
                setTimeout(() => {
                    // Pre-fill task form with suggested tasks
                    const taskForm = document.getElementById('taskForm');
                    if (taskForm && data.suggestedTasks) {
                        const taskTitle = document.getElementById('taskTitle');
                        const taskDescription = document.getElementById('taskDescription');
                        if (taskTitle) taskTitle.value = data.suggestedTasks[0] || 'Scheduled Task';
                        if (taskDescription) taskDescription.value = `Task for site ${data.siteId} - ${data.category} hives`;
                    }
                }, 1000);
            }
        }
        
        // Initialize dashboard functionality after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Make dashboard cards clickable
            setTimeout(() => {
                makeDashboardCardsClickable();
                makeRecentActionsClickable();
            }, 1000);
            
            // Add auto-distribute button
            const hiveCountField = document.getElementById('siteHiveCount');
            if (hiveCountField) {
                hiveCountField.addEventListener('change', autoDistributeHives);
            }
            
            // Handle reports navigation
            handleReportsNavigation();
            
            // Auto-collapse mobile navbar menu after 5 seconds
            const navbarToggler = document.querySelector('.navbar-toggler');
            const navbarCollapse = document.getElementById('navbarNav');
            
            if (navbarToggler && navbarCollapse) {
                let collapseTimeout = null;
                
                // Listen for the navbar being shown
                navbarCollapse.addEventListener('shown.bs.collapse', function() {
                    // Clear any existing timeout
                    if (collapseTimeout) {
                        clearTimeout(collapseTimeout);
                    }
                    
                    // Set new timeout to collapse after 5 seconds
                    collapseTimeout = setTimeout(function() {
                        const bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
                        if (bsCollapse) {
                            bsCollapse.hide();
                        }
                    }, 5000);
                });
                
                // Clear timeout when user manually closes the menu
                navbarCollapse.addEventListener('hidden.bs.collapse', function() {
                    if (collapseTimeout) {
                        clearTimeout(collapseTimeout);
                        collapseTimeout = null;
                    }
                });
            }
        });
    </script>

    <!-- Sync Status Overlay -->
    <div id="syncStatusOverlay" class="sync-status-overlay">
        <div class="sync-status-content">
            <div class="sync-status-icon">
                <i id="syncStatusIcon" class="bi bi-cloud-check"></i>
            </div>
            <div class="sync-status-text">
                <div id="syncStatusText">Synced</div>
                <div id="syncStatusDetails" class="sync-status-details"></div>
            </div>
            <div id="syncStatusCount" class="sync-status-count hidden">0</div>
        </div>
    </div>

    <style>
        /* Sync Status Overlay Styles */
        .sync-status-overlay {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 12px 16px;
            min-width: 140px;
            max-width: 200px;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .sync-status-overlay:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
        }

        .sync-status-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-status-icon {
            font-size: 1.1rem;
            min-width: 20px;
            text-align: center;
        }

        .sync-status-text {
            flex: 1;
            min-width: 0;
        }

        .sync-status-details {
            font-size: 0.75rem;
            color: #666;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sync-status-count {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 20px;
        }

        /* Sync Status States */
        .sync-status-synced {
            color: #28a745;
        }

        .sync-status-syncing {
            color: #007bff;
        }

        .sync-status-offline {
            color: #dc3545;
        }

        .sync-status-error {
            color: #ffc107;
        }

        /* Animation for syncing state */
        .sync-status-syncing .sync-status-icon {
            animation: syncPulse 1.5s ease-in-out infinite;
        }

        @keyframes syncPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .sync-status-overlay {
                bottom: 10px;
                right: 10px;
                min-width: 120px;
                max-width: 160px;
                padding: 10px 12px;
                font-size: 0.8rem;
            }
        }
    </style>
</body>
</html>